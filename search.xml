<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>ARTS-01</title>
    <url>/2019/06/30/ARTS-01/</url>
    <content><![CDATA[<h3 id="Algorithm"><a href="#Algorithm" class="headerlink" title="Algorithm"></a>Algorithm</h3><p>Two Sum ä¸¤æ•°ä¹‹å’Œï¼ˆleetcode #1ï¼‰</p>
<p>â€œå¹³ç”Ÿä¸è¯† TwoSumï¼Œåˆ·å°½ LeetCode ä¹Ÿæ‰ç„¶ã€‚â€</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Given an array of integers, return indices of the two numbers such that they add up to a specific target.</span><br><span class="line"></span><br><span class="line">You may assume that each input would have exactly one solution, and you may not use the same element twice.</span><br><span class="line"></span><br><span class="line">Example:</span><br><span class="line"></span><br><span class="line">Given nums &#x3D; [2, 7, 11, 15], target &#x3D; 9,</span><br><span class="line"></span><br><span class="line">Because nums[0] + nums[1] &#x3D; 2 + 7 &#x3D; 9,</span><br><span class="line">return [0, 1].</span><br></pre></td></tr></table></figure>

<p><strong>è§£é¢˜æ€è·¯</strong>ï¼š<br>æœ¬é¢˜çš„è¦æ±‚æ˜¯æ‰¾åˆ°ä¸¤æ•°ä¹‹å’Œç­‰äº target çš„ä»¥è¿™ä¸¤ä¸ªæ•°çš„ä¸‹è¡¨ä¸ºå…ƒç´ çš„æ•°ç»„ï¼Œåˆæ­¥çš„æƒ³æ³•åº”è¯¥ç”¨HashMap å­˜ä¸‹éå† numsæ•°ç»„çš„ä¸‹è¡¨ä¸å¯¹åº”çš„å€¼ï¼Œå¹¶ä¸”åˆ¤æ–­å½“ ç”¨targetå‡å» å·²å­˜åœ¨çš„æ•°å¾—åˆ°æ•°ç»„ä¸­å¦ä¸€ä¸ªæ•°æ—¶ï¼Œæ»¡è¶³é¢˜ç›®çš„è¦æ±‚ï¼Œè¿”å›ä»–ä»¬çš„ä¸‹æ ‡ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    public int[] twoSum(int[] nums, int target) &#123;</span><br><span class="line">        HashMap&lt;Integer, Integer&gt; map &#x3D; new HashMap&lt;&gt;();</span><br><span class="line">        int[] result &#x3D; new int[2];</span><br><span class="line">        for (int i &#x3D; 0; i &lt; nums.length; i++) &#123;</span><br><span class="line">            if (map.containsKey(target - nums[i])) &#123;</span><br><span class="line">                result[0] &#x3D; map.get(target - nums[i]);</span><br><span class="line">                result[1] &#x3D; i;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            map.put(nums[i], i);</span><br><span class="line">        &#125;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Reading"><a href="#Reading" class="headerlink" title="Reading"></a>Reading</h3><p><strong>Top Signs of an Over-Experienced Programmer</strong><br><a href="https://medium.com/better-programming/top-signs-of-an-over-experienced-programmer-22bbe0b57663" target="_blank" rel="noopener">https://medium.com/better-programming/top-signs-of-an-over-experienced-programmer-22bbe0b57663</a></p>
<p>åªè¦æˆ‘ä»¬è¿˜æ˜¯programmer æˆ‘ä»¬çš„é‡å¿ƒè¿˜æ˜¯è¦æ”¾åˆ°programming ä¸ engineering ä¸Šï¼Œè¿‡åº¦åœ°è€ƒè™‘éœ€æ±‚æ˜¯å¦åˆç†ï¼Œé¡¹ç›®æ˜¯å¦èƒ½æ»¡è¶³ç”¨æˆ·éœ€æ±‚ç­‰å¹¶ä¸æ˜¯æˆ‘ä»¬éœ€è¦è€ƒè™‘çš„é‡å¿ƒã€‚æˆ‘ä»¬éœ€è¦é¿å…ä¸å¿…è¦çš„refactoringï¼Œä»¥å°½å¯èƒ½perfectåœ°å®ç°éœ€æ±‚ä¸ºç›®æ ‡ï¼Œæ·±å…¥åˆ°code engineeringæ‰æ˜¯ã€‚</p>
<h3 id="Tip"><a href="#Tip" class="headerlink" title="Tip"></a>Tip</h3><p><strong>æœ¬å‘¨åœ¨åšæ–°é¡¹ç›®æ—¶åˆé‡æ–°ç”¨åˆ°äº† hibernate mybatis å’Œ jdbcTemplateã€‚ä¸‹é¢é’ˆå¯¹è¿™äº›å·¥å…·æˆ‘ä¸ªäººçš„ä¸€äº›çœ‹æ³•</strong></p>
<ul>
<li>hibernate è™½ç„¶æ¯”è¾ƒæ–¹ä¾¿ï¼Œç»“åˆSpring Data JPA å¯ä»¥éå¸¸æ–¹ä¾¿çš„å†™å‡ºcrudé€»è¾‘ï¼Œä½†ç¼ºç‚¹ä¹Ÿéå¸¸æ˜æ˜¾ï¼Œå°±æ˜¯ç›¸å¯¹å…¶ä»–ä¸¤ä¸ªæ¥è¯´å¤ªä¸çµæ´»äº†ï¼Œå¦‚æœä¸å°å¿ƒå¼€å¯äº†è‡ªåŠ¨ç”Ÿæˆæ•°æ®åº“çš„é…ç½®ï¼Œè‡ªåŠ¨ç”Ÿæˆçš„å¤–é”®å¤Ÿè®©ä½ éš¾å—çš„äº†ã€‚</li>
<li>mybatis ä½¿ç”¨èµ·æ¥ä¸­è§„ä¸­çŸ©ï¼Œä½†è¿˜æ˜¯ä¸å¤Ÿçµæ´»ï¼Œä»¿ä½›æ‰è¿›äº†ç»´æŠ¤æ•°æ®è¡¨é—´å…³ç³»çš„å‘é‡Œã€‚</li>
<li>jdbcTemplate æˆ‘ç”¨å¾—æœ€é¡ºæ‰‹ï¼Œç‰¹åˆ«æ˜¯ NamedParameterJdbcTemplateï¼Œé€šè¿‡æ‰‹åŠ¨æ‹¼æ¥SQLå®ç°å¤æ‚çš„é€»è¾‘éå¸¸å¥½ç”¨ï¼Œè¿˜ä¸å¿…åƒåœ¨PreparedStatementä¸­ä¸€æ ·æ•°é—®å·ğŸ¤£</li>
</ul>
<h3 id="Share"><a href="#Share" class="headerlink" title="Share"></a>Share</h3><p><strong>æœ¬å‘¨åˆ†äº«çš„æ–‡ç« æ˜¯æ¥è‡ª é˜¿é‡Œäº‘äº‘æ –ç¤¾åŒº çš„ä¸€ç¯‡å…³äºHashMapçš„æ–‡ç« </strong><br>ç”±é˜¿é‡Œå·´å·´Javaå¼€å‘è§„çº¦HashMapæ¡ç›®å¼•å‘çš„æ•…äº‹<br><a href="https://zhuanlan.zhihu.com/p/30360734" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/30360734</a></p>
]]></content>
      <categories>
        <category>ARTS</category>
      </categories>
      <tags>
        <tag>ARTS</tag>
      </tags>
  </entry>
  <entry>
    <title>ARTS-02.md</title>
    <url>/2019/07/14/ARTS-02/</url>
    <content><![CDATA[<h3 id="Algorithm"><a href="#Algorithm" class="headerlink" title="Algorithm"></a>Algorithm</h3><p>Print in Orderï¼ˆ1114ï¼‰</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Suppose we have a class:</span><br><span class="line"></span><br><span class="line">public class Foo &#123;</span><br><span class="line">Â  public void one() &#123; print(&quot;one&quot;); &#125;</span><br><span class="line">Â  public void two() &#123; print(&quot;two&quot;); &#125;</span><br><span class="line">Â  public void three() &#123; print(&quot;three&quot;); &#125;</span><br><span class="line">&#125;</span><br><span class="line">The same instance of Foo will be passed to three different threads. Thread A will call one(), thread B will call two(), and thread C will call three(). Design a mechanism and modify the programÂ to ensure thatÂ two()Â is executed afterÂ one(), andÂ three() is executed afterÂ two().</span><br><span class="line"></span><br><span class="line">æ¥æºï¼šåŠ›æ‰£ï¼ˆLeetCodeï¼‰</span><br><span class="line">é“¾æ¥ï¼šhttps:&#x2F;&#x2F;leetcode-cn.com&#x2F;problems&#x2F;print-in-order</span><br><span class="line">è‘—ä½œæƒå½’é¢†æ‰£ç½‘ç»œæ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»å®˜æ–¹æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</span><br></pre></td></tr></table></figure>
<p><strong>è§£é¢˜æ€è·¯</strong>ï¼š<br>leetcodeå…³äºå¤šçº¿ç¨‹çš„æ–°é¢˜ï¼Œè€ƒå¯Ÿå¤šçº¿ç¨‹ä¸­çš„æŒ‰åºæ‰§è¡Œã€‚<br>å¯ä»¥ç”¨ä»¥ä¸‹æ–¹æ³•è§£ï¼š</p>
<ol>
<li>åˆ©ç”¨CountDownLatch æ¥æ§åˆ¶æ‰§è¡Œçš„é¡ºåºã€‚</li>
<li>åˆ©ç”¨volatile åˆ›å»ºå…¨å±€å¯è§çš„å˜é‡ï¼Œé€šè¿‡å¯¹è¯¥å˜é‡çš„åŸå­æ€§æ›´æ–°æ¥ä¿è¯æ‰§è¡Œé¡ºåºã€‚</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import java.util.concurrent.CountDownLatch;</span><br><span class="line"></span><br><span class="line">class Foo &#123;</span><br><span class="line">    private CountDownLatch c2;</span><br><span class="line">    private CountDownLatch c3;</span><br><span class="line"></span><br><span class="line">    public Foo() &#123;</span><br><span class="line">        c2 &#x3D; new CountDownLatch(1);</span><br><span class="line">        c3 &#x3D; new CountDownLatch(1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void first(Runnable printFirst) throws InterruptedException &#123;</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F; printFirst.run() outputs &quot;first&quot;. Do not change or remove this line.</span><br><span class="line">        printFirst.run();</span><br><span class="line">        c2.countDown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void second(Runnable printSecond) throws InterruptedException &#123;</span><br><span class="line">        c2.await();</span><br><span class="line">        &#x2F;&#x2F; printSecond.run() outputs &quot;second&quot;. Do not change or remove this line.</span><br><span class="line">        printSecond.run();</span><br><span class="line">        c3.countDown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void third(Runnable printThird) throws InterruptedException &#123;</span><br><span class="line">        c3.await();</span><br><span class="line">        &#x2F;&#x2F; printThird.run() outputs &quot;third&quot;. Do not change or remove this line.</span><br><span class="line">        printThird.run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class Foo &#123;</span><br><span class="line"></span><br><span class="line">    private volatile int flag &#x3D; 1;</span><br><span class="line">    public Foo() &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void first(Runnable printFirst) throws InterruptedException &#123;</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F; printFirst.run() outputs &quot;first&quot;. Do not change or remove this line.</span><br><span class="line">        printFirst.run();</span><br><span class="line">        flag &#x3D; 2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void second(Runnable printSecond) throws InterruptedException &#123;</span><br><span class="line">        while(flag !&#x3D; 2);</span><br><span class="line">        &#x2F;&#x2F; printSecond.run() outputs &quot;second&quot;. Do not change or remove this line.</span><br><span class="line">        printSecond.run();</span><br><span class="line">        flag &#x3D; 3;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void third(Runnable printThird) throws InterruptedException &#123;</span><br><span class="line">        while(flag !&#x3D; 3);</span><br><span class="line">        &#x2F;&#x2F; printThird.run() outputs &quot;third&quot;. Do not change or remove this line.</span><br><span class="line">        printThird.run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Reading"><a href="#Reading" class="headerlink" title="Reading"></a>Reading</h3><p><strong>Faircode, an alternative to Open Source that aims to get developers paid</strong><br><a href="https://hackernoon.com/faircode-an-alternative-to-open-source-89cdc65df3fa" target="_blank" rel="noopener">https://hackernoon.com/faircode-an-alternative-to-open-source-89cdc65df3fa</a></p>
<p>åœ¨2017å¹´ä½œè€…æå‡ºäº†Faircodeè¿™ä¸ªæ¦‚å¿µï¼Œæ—¨åœ¨ç»™å¼€å‘è€…ä¸€ä¸ªæ–°çš„ç›ˆåˆ©æ–¹å¼ã€‚ä¸åŒäºâ€œé—­æºè½¯ä»¶â€ï¼ŒFaircode æ‰“ç®—ä»¥å‘å¤§å…¬å¸æ”¶è´¹è€Œå¯¹å°å…¬å¸å…è´¹çš„å½¢åŠ¿è·åˆ©ã€‚ç„¶è€Œä¸å¹¸çš„æ˜¯ï¼Œä½œè€…å‘èµ·çš„Faircode åŠç›¸å…³çš„license å·²ç»è¢«åˆ é™¤äº†ã€‚ä½œè€…æƒ³æ³•åœ¨å½“æ—¶æ¯”è¾ƒå‰å«ï¼Œå¯èƒ½åœ¨æ¨è¡Œçš„è¿‡ç¨‹ä¸­æˆæ•ˆä¸å¤§å§ã€‚</p>
<h3 id="Tip"><a href="#Tip" class="headerlink" title="Tip"></a>Tip</h3><p><a href="https://javarevisited.blogspot.com/2018/05/10-tips-to-become-better-java-developer.html" target="_blank" rel="noopener">https://javarevisited.blogspot.com/2018/05/10-tips-to-become-better-java-developer.html</a></p>
<h3 id="Share"><a href="#Share" class="headerlink" title="Share"></a>Share</h3><p>JAVA æ³¨è§£çš„åŸºæœ¬åŸç†</p>
<p><a href="https://juejin.im/post/5b45bd715188251b3a1db54f" target="_blank" rel="noopener">https://juejin.im/post/5b45bd715188251b3a1db54f</a></p>
]]></content>
      <categories>
        <category>ARTS</category>
      </categories>
      <tags>
        <tag>ARTS</tag>
      </tags>
  </entry>
  <entry>
    <title>ARTS-03</title>
    <url>/2019/07/26/ARTS-03/</url>
    <content><![CDATA[<h3 id="Algorithm"><a href="#Algorithm" class="headerlink" title="Algorithm"></a>Algorithm</h3><p>Add Two Numbers(#2)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * @lc app&#x3D;leetcode.cn id&#x3D;2 lang&#x3D;java</span><br><span class="line"> *</span><br><span class="line"> * [2] ä¸¤æ•°ç›¸åŠ </span><br><span class="line"> *&#x2F;</span><br><span class="line">&#x2F;**</span><br><span class="line"> * Definition for singly-linked list.</span><br><span class="line"> * public class ListNode &#123;</span><br><span class="line"> *     int val;</span><br><span class="line"> *     ListNode next;</span><br><span class="line"> *     ListNode(int x) &#123; val &#x3D; x; &#125;</span><br><span class="line"> * &#125;</span><br><span class="line"> *&#x2F;</span><br><span class="line">class Solution &#123;</span><br><span class="line">    public ListNode addTwoNumbers(ListNode l1, ListNode l2) &#123;</span><br><span class="line">        ListNode pre &#x3D; new ListNode(0);</span><br><span class="line">        ListNode cur &#x3D; pre;</span><br><span class="line">        int carry &#x3D; 0;</span><br><span class="line">        while (l1 !&#x3D; null || l2 !&#x3D; null) &#123;</span><br><span class="line">            int x &#x3D; l1 &#x3D;&#x3D; null ? 0 : l1.val;</span><br><span class="line">            int y &#x3D; l2 &#x3D;&#x3D; null ? 0 : l2.val;</span><br><span class="line">            int sum &#x3D; x + y + carry;</span><br><span class="line">            </span><br><span class="line">            carry &#x3D; sum &#x2F; 10;</span><br><span class="line">            sum &#x3D; sum % 10;</span><br><span class="line">            cur.next &#x3D; new ListNode(sum);</span><br><span class="line"></span><br><span class="line">            cur &#x3D; cur.next;</span><br><span class="line">            if (l1 !&#x3D; null) &#123;</span><br><span class="line">                l1 &#x3D; l1.next;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (l2 !&#x3D; null) &#123;</span><br><span class="line">                l2 &#x3D; l2.next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (carry &#x3D;&#x3D; 1) &#123;</span><br><span class="line">            cur.next &#x3D; new ListNode(carry);</span><br><span class="line">        &#125;</span><br><span class="line">        return pre.next;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é“é¢˜æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªè¾…åŠ©èŠ‚ç‚¹pre å†ç”¨ä¸€ä¸ªèŠ‚ç‚¹curæŒ‡å‘æˆ‘ä»¬æ­£åœ¨è¿›è¡Œè®¡ç®—çš„ç»“æœé“¾è¡¨ä¸Šçš„èŠ‚ç‚¹ã€‚</p>
<p>é€šè¿‡å¯¹l1, l2è¿™ä¸¤æ¡é“¾åšéå†ï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—l1, l2 å½“å‰èŠ‚ç‚¹çš„å€¼x å’Œ yï¼Œå¯ä»¥è®¡ç®—å‡ºä»–ä»¬ä¸è¿›ä½æ ‡è¯†ï¼ˆå˜é‡carryï¼Œåˆå§‹å€¼ä¸º0ï¼‰çš„å’Œsumã€‚å¯ä»¥é€šè¿‡å¯¹carryè¢«10æ•´é™¤çš„ä½™æ•°æ¥å¾—çŸ¥å½“å‰èŠ‚ç‚¹çš„ä¸¤æ•°ç›¸åŠ æ˜¯å¦è¿›ä½ã€‚é€šè¿‡å¯¹sumçš„å€¼å¯¹10å–modï¼Œå¯ä»¥å¾—åˆ°åŠ äº†è¿›ä½åçš„å€¼ã€‚</p>
<p>ä¹‹åå°±æ˜¯åˆ›å»ºè¾…åŠ©èŠ‚ç‚¹é“¾çš„åä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶æŠŠcuræŒ‡å‘æ–°èŠ‚ç‚¹ã€‚å¦‚æœè¿™æ¬¡è¿ç®—æœ‰è¿›ä½ï¼Œåˆ™å†æ–°å¢ä¸€ä¸ªå€¼ä¸ºcarryçš„èŠ‚ç‚¹ã€‚ è¿™æ ·é‡å¤ç›´åˆ°l1 æˆ– l2åˆ°è¾¾é“¾å°¾ï¼Œå¦‚æœä¸åŒæ—¶åˆ°è¾¾é“¾å°¾ï¼Œåˆ™ç»“æœé“¾è¡¨ä¾æ¬¡æŠŠæœªåˆ°è¾¾é“¾å°¾çš„æ•°å¤åˆ¶ï¼Œæœ€ål1ï¼Œl2éƒ½åˆ°è¾¾é“¾å°¾ï¼Œè®¡ç®—ç»“æŸã€‚</p>
<h3 id="Reading"><a href="#Reading" class="headerlink" title="Reading"></a>Reading</h3><p><strong>Python at Netflix</strong></p>
<p><a href="https://medium.com/netflix-techblog/python-at-netflix-bba45dae649e" target="_blank" rel="noopener">https://medium.com/netflix-techblog/python-at-netflix-bba45dae649e</a></p>
<p>è¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº†Pythonåœ¨NetflixæŠ€æœ¯æ¶æ„ä¸­çš„åº”ç”¨ã€‚ç»™æƒ³è¦ç”¨Pythonæäº‹æƒ…çš„æœ‹å‹ä»¬ä¸€äº›æœ‰äº‹å®æ”¯æŒçš„æ€è·¯ã€‚</p>
<h3 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h3><p>æœ¬å‘¨åˆ†äº«ä¸€ä¸‹Javaå†…å­˜æ¨¡å‹çš„happen beforeåŸåˆ™</p>
<ol>
<li>ç¨‹åºæ¬¡åºè§„åˆ™ï¼šåœ¨ä¸€ä¸ªçº¿ç¨‹å†…ï¼ŒæŒ‰ç…§ç¨‹åºä»£ç é¡ºåºï¼Œä¹¦å†™åœ¨å‰é¢çš„æ“ä½œhappens beforeäºä¹¦å†™åœ¨åé¢çš„æ“ä½œã€‚å‡†ç¡®åœ°è¯´ï¼Œåº”è¯¥æ˜¯æ§åˆ¶æµé¡ºåºè€Œä¸æ˜¯ç¨‹åºä»£ç é¡ºåºï¼Œå› ä¸ºè¦è€ƒè™‘åˆ†æ”¯ã€å¾ªç¯ç­‰ç»“æ„ã€‚å¦‚æœåœ¨ä¸€ä¸ªçº¿ç¨‹çš„æ“ä½œï¼Œé‚£ä¹ˆå‰ä¸€ä¸ªæ“ä½œçš„ç»“æœå¿…å®šå¯¹åç»­æ“ä½œå¯è§ã€‚</li>
<li>ç®¡ç¨‹é”å®šè§„åˆ™ï¼šä¸€ä¸ªunlockæ“ä½œhappens beforeäºåé¢å¯¹åŒä¸€ä¸ªé”çš„lockæ“ä½œã€‚è¿™é‡Œå¿…é¡»å¼ºè°ƒçš„æ˜¯åŒä¸€ä¸ªé”ï¼Œè€Œâ€åé¢â€æ˜¯æŒ‡æ—¶é—´ä¸Šçš„å…ˆåé¡ºåºã€‚æœ€å¸¸è§çš„å°±æ˜¯syncronized æ–¹æ³•å’Œsyncronizedä»£ç å—ã€‚</li>
<li>volatileå˜é‡è§„åˆ™ï¼šå¯¹ä¸€ä¸ªvolatileå˜é‡çš„å†™æ“ä½œhappens beforeäºåé¢å¯¹è¿™ä¸ªå˜é‡çš„è¯»æ“ä½œï¼Œè¿™é‡Œçš„â€åé¢â€åŒæ ·æ˜¯æŒ‡æ—¶é—´ä¸Šçš„å…ˆåé¡ºåºã€‚è¯¥è§„åˆ™åœ¨ConcurrentHashMap ä¸­è¯»æ“ä½œä¸éœ€è¦åŠ é”ä¸­æœ‰å¾ˆå¥½çš„ä½“ç°ã€‚</li>
<li>çº¿ç¨‹å¯åŠ¨è§„åˆ™ï¼šThreadå¯¹è±¡çš„start()æ–¹æ³•happens beforeäºæ­¤çº¿ç¨‹çš„æ¯ä¸€ä¸ªåŠ¨ä½œã€‚</li>
<li>çº¿ç¨‹ç»ˆæ­¢è§„åˆ™ï¼šçº¿ç¨‹ä¸­çš„æ‰€æœ‰æ“ä½œéƒ½å…ˆè¡Œå‘ç”Ÿäºå¯¹æ­¤çº¿ç¨‹çš„ç»ˆæ­¢æ£€æµ‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡Thread.joinï¼ˆï¼‰æ–¹æ³•ç»“æŸã€Thread.isAliveï¼ˆï¼‰çš„è¿”å›å€¼ç­‰æ‰‹æ®µæ£€æµ‹åˆ°çº¿ç¨‹å·²ç»ç»ˆæ­¢æ‰§è¡Œã€‚</li>
<li>çº¿ç¨‹ä¸­æ–­è§„åˆ™ï¼šå¯¹çº¿ç¨‹interrupt()æ–¹æ³•çš„è°ƒç”¨å…ˆè¡Œå‘ç”Ÿäºè¢«ä¸­æ–­çº¿ç¨‹çš„ä»£ç æ£€æµ‹åˆ°ä¸­æ–­äº‹ä»¶çš„å‘ç”Ÿï¼Œå¯ä»¥é€šè¿‡Thread.interrupted()æ–¹æ³•æ£€æµ‹åˆ°æ˜¯å¦æœ‰ä¸­æ–­å‘ç”Ÿã€‚</li>
<li>å¯¹è±¡ç»ˆç»“è§„åˆ™ï¼šä¸€ä¸ªå¯¹è±¡çš„åˆå§‹åŒ–å®Œæˆ(æ„é€ å‡½æ•°æ‰§è¡Œç»“æŸ)å…ˆè¡Œå‘ç”Ÿäºå®ƒçš„finalize()æ–¹æ³•çš„å¼€å§‹ã€‚</li>
</ol>
<p>ä¼ é€’æ€§ï¼šå¦‚æœ A happens before Bï¼Œä¸”B happens before Cï¼Œåˆ™A happens before C</p>
<h3 id="Share"><a href="#Share" class="headerlink" title="Share"></a>Share</h3><p>æ‰“é€  Mac ä¸‹é«˜é¢œå€¼å¥½ç”¨çš„ç»ˆç«¯ç¯å¢ƒ</p>
<p><a href="https://blog.biezhi.me/2018/11/build-a-beautiful-mac-terminal-environment.html" target="_blank" rel="noopener">https://blog.biezhi.me/2018/11/build-a-beautiful-mac-terminal-environment.html</a></p>
]]></content>
      <categories>
        <category>ARTS</category>
      </categories>
      <tags>
        <tag>ARTS</tag>
      </tags>
  </entry>
  <entry>
    <title>ARTS-04</title>
    <url>/2019/08/02/ARTS-04/</url>
    <content><![CDATA[<h3 id="Algorithm"><a href="#Algorithm" class="headerlink" title="Algorithm"></a>Algorithm</h3><p>æ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²(3)</p>
<p><strong>è§£æ³•1:</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @lc app=leetcode.cn id=3 lang=java</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * [3] æ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">lengthOfLongestSubstring</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> l = s.length();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; l; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = i + <span class="number">1</span>; j &lt;= l; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (allUnique(s, i, j)) &#123;</span><br><span class="line">                    result = Math.max(result, j - i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">allUnique</span><span class="params">(String s, <span class="keyword">int</span> start, <span class="keyword">int</span> end)</span> </span>&#123;</span><br><span class="line">        Set&lt;Character&gt; set = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = start; i &lt; end; i++) &#123;</span><br><span class="line">            Character c = s.charAt(i);</span><br><span class="line">            <span class="keyword">if</span> (!set.contains(c)) &#123;</span><br><span class="line">                set.add(c);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æš´åŠ›ç ´è§£æ³•æ²¡å•¥å¥½è¯´çš„, ç›´æ¥è¶…æ—¶äº†, æ˜¾ç„¶æ˜¯ä¸å¯è¡Œçš„.<br>æ—¶é—´å¤æ‚åº¦ï¼šO(n^3)</p>
<p><strong>è§£æ³•2:</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>ARTS</category>
      </categories>
      <tags>
        <tag>ARTS</tag>
      </tags>
  </entry>
  <entry>
    <title>Java ä¸­æ¥å£ä¸æŠ½è±¡ç±»çš„åŒºåˆ«</title>
    <url>/2019/07/02/Java-%E4%B8%AD%E6%8E%A5%E5%8F%A3%E4%B8%8E%E6%8A%BD%E8%B1%A1%E7%B1%BB%E7%9A%84%E5%8C%BA%E5%88%AB/</url>
    <content><![CDATA[<h4 id="æŠ½è±¡ç±»ï¼š"><a href="#æŠ½è±¡ç±»ï¼š" class="headerlink" title="æŠ½è±¡ç±»ï¼š"></a>æŠ½è±¡ç±»ï¼š</h4><h5 id="å®šä¹‰ï¼š"><a href="#å®šä¹‰ï¼š" class="headerlink" title="å®šä¹‰ï¼š"></a>å®šä¹‰ï¼š</h5><p>å¦‚æœä¸€ä¸ªç±»æœ‰æŠ½è±¡æ–¹æ³•ï¼Œåˆ™ç§°è¿™ä¸ªç±»ä¸ºæŠ½è±¡ç±»ã€‚ä½¿ç”¨abstractä¿®é¥°æŠ½è±¡ç±»ã€‚<br>æŠ½è±¡ç±»ä¸­å¯èƒ½å«æœ‰æ— å…·ä½“å®ç°çš„æ–¹æ³•ï¼Œæ•…ä¸èƒ½ç”¨æŠ½è±¡ç±»åˆ›å»ºå¯¹è±¡ã€‚æŠ½è±¡æ–¹æ³•æ˜¯ä¸€ç§ç‰¹æ®Šçš„æ–¹æ³•ï¼Œåªæœ‰å£°æ˜ï¼Œæ²¡æœ‰å®ç°ã€‚å¦‚æœä¸€ä¸ªç±»ç»§æ‰¿æŠ½è±¡ç±»ï¼Œåˆ™å¿…é¡»å®ç°çˆ¶ç±»çš„æŠ½è±¡æ–¹æ³•ï¼Œå¦‚æœä¸è¿™ä¹ˆåšï¼Œåˆ™æ­¤ç±»ä¹Ÿåº”è¯¥ä¸ºæŠ½è±¡ç±»ã€‚</p>
<h5 id="æŠ½è±¡ç±»ä¸æ™®é€šç±»çš„åŒºåˆ«"><a href="#æŠ½è±¡ç±»ä¸æ™®é€šç±»çš„åŒºåˆ«" class="headerlink" title="æŠ½è±¡ç±»ä¸æ™®é€šç±»çš„åŒºåˆ«"></a>æŠ½è±¡ç±»ä¸æ™®é€šç±»çš„åŒºåˆ«</h5><ol>
<li>æŠ½è±¡æ–¹æ³•çš„è®¿é—®ä¿®é¥°ç¬¦å¿…é¡»ä¸ºpublic æˆ–è€… protectedï¼ˆå¦‚æœä¸ºprivate åˆ™ä¸èƒ½è¢«å­ç±»ç»§æ‰¿ï¼Œå­ç±»æ— æ³•å®ç°è¯¥æ–¹æ³•ï¼‰ï¼Œé»˜è®¤ä¸ºpublicã€‚</li>
<li>æŠ½è±¡ç±»ä¸èƒ½ç”¨æ¥åˆ›å»ºå¯¹è±¡ã€‚</li>
<li>å¦‚æœä¸€ä¸ªç±»ç»§æ‰¿äºä¸€ä¸ªæŠ½è±¡ç±»ï¼Œåˆ™å­ç±»å¿…é¡»å®ç°çˆ¶ç±»çš„æ‰€æœ‰æŠ½è±¡æ–¹æ³•ã€‚å¦‚æœå­ç±»æ²¡æœ‰å®ç°ï¼Œåˆ™å¿…é¡»å®šä¹‰ä¸ºabstract classã€‚</li>
</ol>
<h4 id="æ¥å£"><a href="#æ¥å£" class="headerlink" title="æ¥å£"></a>æ¥å£</h4><p>å¯ä»¥å«æœ‰å˜é‡å’Œæ–¹æ³•ã€‚<br>ä½†æ˜¯æ¥å£ä¸­édefaultçš„æ–¹æ³•æ˜¯éšå¼æŠ½è±¡çš„,æ¥å£ä¸­çš„æ–¹æ³•ä¼šè¢«éšå¼çš„æŒ‡å®šä¸º public abstractï¼ˆåªèƒ½æ˜¯ public abstractï¼ˆ1.8ä»¥åå¯ä»¥æ˜¯defaultï¼‰ï¼Œå…¶ä»–ä¿®é¥°ç¬¦éƒ½ä¼šæŠ¥é”™ï¼‰ã€‚<br>æ¥å£ä¸­å¯ä»¥å«æœ‰å˜é‡ï¼Œä½†æ˜¯æ¥å£ä¸­çš„å˜é‡ä¼šè¢«éšå¼çš„æŒ‡å®šä¸º public static final å˜é‡ï¼ˆå¹¶ä¸”åªèƒ½æ˜¯ publicï¼Œç”¨ private ä¿®é¥°ä¼šæŠ¥ç¼–è¯‘é”™è¯¯ï¼‰ã€‚</p>
<h5 id="æŠ½è±¡ç±»å’Œæ¥å£çš„åŒºåˆ«"><a href="#æŠ½è±¡ç±»å’Œæ¥å£çš„åŒºåˆ«" class="headerlink" title="æŠ½è±¡ç±»å’Œæ¥å£çš„åŒºåˆ«"></a>æŠ½è±¡ç±»å’Œæ¥å£çš„åŒºåˆ«</h5><ol>
<li>æŠ½è±¡ç±»ä¸­çš„æ–¹æ³•å¯ä»¥æœ‰æ–¹æ³•ä½“ï¼Œå°±æ˜¯èƒ½å®ç°æ–¹æ³•çš„å…·ä½“åŠŸèƒ½ï¼Œä½†æ˜¯æ¥å£ä¸­çš„æ–¹æ³•ä¸è¡Œã€‚(Java 1.8ä»¥åæ¥å£å¯ä»¥æœ‰å¯ä»¥å®ç°çš„defaultæ–¹æ³•)</li>
<li>æŠ½è±¡ç±»ä¸­çš„æˆå‘˜å˜é‡å¯ä»¥æ˜¯å„ç§ç±»å‹çš„ï¼Œè€Œæ¥å£ä¸­çš„æˆå‘˜å˜é‡åªèƒ½æ˜¯ public static final ç±»å‹çš„ã€‚</li>
<li>æ¥å£ä¸­ä¸èƒ½å«æœ‰é™æ€ä»£ç å—ä»¥åŠé™æ€æ–¹æ³•(ç”¨ static ä¿®é¥°çš„æ–¹æ³•)ï¼Œè€ŒæŠ½è±¡ç±»æ˜¯å¯ä»¥æœ‰é™æ€ä»£ç å—å’Œé™æ€æ–¹æ³•ã€‚</li>
<li>ä¸€ä¸ªç±»åªèƒ½ç»§æ‰¿ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œè€Œä¸€ä¸ªç±»å´å¯ä»¥å®ç°å¤šä¸ªæ¥å£ã€‚</li>
</ol>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>interview</tag>
      </tags>
  </entry>
  <entry>
    <title>Java Exception &amp; Error</title>
    <url>/2019/05/22/Java-Exception-Error/</url>
    <content><![CDATA[<p>###java.lang.ClassNotFoundException</p>
<p>This exception indicates that the class was not found on the classpath. This indicates that we were trying to load the class definition, and the class did not exist on the classpath.</p>
<p>###java.lang.NoClassDefFoundError<br>This exception indicates that the JVM looked in its internal class definition data structure for the definition of a class and did not find it. This is different than saying that it could not be loaded from the classpath. Usually this indicates that we previously attempted to load a class from the classpath, but it failed for some reason - now weâ€™re trying to use the class again (and thus need to load it, since it failed last time), but weâ€™re not even going to try to load it, because we failed loading it earlier (and reasonably suspect that we would fail again). The earlier failure could be a ClassNotFoundException or an ExceptionInInitializerError (indicating a failure in the static initialization block) or any number of other problems. The point is, a NoClassDefFoundError is not necessarily a classpath problem.</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Rediså…«è‚¡æ–‡</title>
    <url>/2020/09/03/Redis%E5%85%AB%E8%82%A1%E6%96%87/</url>
    <content><![CDATA[<h2 id="åº”ç”¨ç¯‡"><a href="#åº”ç”¨ç¯‡" class="headerlink" title="åº”ç”¨ç¯‡"></a>åº”ç”¨ç¯‡</h2><ol>
<li>Redis æœ‰å“ªäº›æ•°æ®ç»“æ„ï¼Œåˆ†åˆ«æœ‰ä»€ä¹ˆä½¿ç”¨åœºæ™¯ï¼Ÿ</li>
<li>Redis ZSET ç›¸åŒ score å¦‚ä½•æ’åºï¼Ÿ</li>
<li>åœ¨çˆ¬è™«ä¸­ï¼Œå¦‚ä½•ä½¿ç”¨ Redis åš URL å»é‡ï¼Ÿ</li>
<li>Redis æ˜¯å¦æ”¯æŒäº‹åŠ¡ï¼Ÿ</li>
<li>Redis ä¸­çš„ WATCH å‘½ä»¤æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ</li>
<li>Redis æ˜¯å¦‚ä½•ä¿è¯é«˜å¯ç”¨çš„ï¼Ÿ</li>
<li>å¦‚ä½•ä½¿ç”¨ Redis æ¥å®ç°åˆ†å¸ƒå¼é”ï¼ŸRedlockï¼Ÿ</li>
</ol>
]]></content>
      <categories>
        <category>redis</category>
      </categories>
      <tags>
        <tag>redis</tag>
      </tags>
  </entry>
  <entry>
    <title>Soul ç½‘å…³æºç åˆ†æï¼ˆäºŒï¼‰divide, rewrite æ’ä»¶</title>
    <url>/2021/01/16/Soul-%E7%BD%91%E5%85%B3%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88%E4%BA%8C%EF%BC%89divide-rewrite-%E6%8F%92%E4%BB%B6/</url>
    <content><![CDATA[<p>åœ¨ä¸Šä¸€èŠ‚é‡Œæˆ‘ä»¬ç¼–è¯‘å¥½äº† Soul ç½‘å…³çš„æºç ï¼Œä»Šå¤©æˆ‘ä»¬ä»rewriteæ’ä»¶å¼€å§‹å­¦ä¹ å¦‚ä½•å¯¹æœåŠ¡è¿›è¡Œä»£ç†å¹¶é‡å†™è·¯å¾„ã€‚</p>
<a id="more"></a>

<p>é¦–å…ˆæˆ‘ä»¬ç”¨Pythonå†™ä¸€ä¸ªç®€å•çš„Flaskåº”ç”¨ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/foo/bar/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Hello World!'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>

<p>å¯åŠ¨æœåŠ¡åï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç°åœ¨è®¾ç½®çš„è·¯å¾„ä¸ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1:5000&#x2F;foo&#x2F;bar&#x2F;</span><br></pre></td></tr></table></figure>
<p>å°è¯•ä½¿ç”¨ curl è®¿é—®å¯¹åº”çš„æ¥å£ï¼š<br><img src="https://img-blog.csdnimg.cn/20210115211421555.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>OKï¼ŒæœåŠ¡æ­£å¸¸ã€‚</p>
<p>æˆ‘ä»¬åœ¨ soul-admin é€‰æ‹© <strong>rewrite</strong> æ’ä»¶ï¼Œç‚¹å‡»æ·»åŠ é€‰æ‹©å™¨ï¼š<br><img src="https://img-blog.csdnimg.cn/20210115210809657.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dpY2tlZFdpbmdz,size_16,color_FFFFFF,t_70" alt="é€‰æ‹©æ·»åŠ é€‰æ‹©å™¨"><br>åœ¨å¼¹å‡ºçš„å¯¹è¯æ¡†ä¸­è¾“å…¥ï¼š<br><img src="https://img-blog.csdnimg.cn/20210115211626802.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dpY2tlZFdpbmdz,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>ç‚¹å‡»ç¡®è®¤åï¼Œé€šè¿‡ Chrome debug å¯ä»¥æ•è·åˆ°å‰ç«¯å‘èµ·çš„ä¸‰ä¸ªè¯·æ±‚ï¼Œåˆ†åˆ«æ˜¯ï¼š</p>
<ol>
<li>/selector</li>
<li>/selector?pluginId=3&amp;currentPage=1&amp;pageSize=12</li>
<li>/rule?currentPage=1&amp;pageSize=12&amp;selectorId=1350069791219036160</li>
</ol>
<p>æˆ‘ä»¬è¿½è¸ªåˆ°å¯¹åº”çš„æºç å¯ä»¥çœ‹åˆ°ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * query Selectors.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pluginId    plugin id.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> currentPage current page.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pageSize    page size.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="doctag">@linkplain</span> SoulAdminResult&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">""</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> SoulAdminResult <span class="title">querySelectors</span><span class="params">(<span class="keyword">final</span> String pluginId, <span class="keyword">final</span> Integer currentPage, <span class="keyword">final</span> Integer pageSize)</span> </span>&#123;</span><br><span class="line">    CommonPager&lt;SelectorVO&gt; commonPager = selectorService.listByPage(<span class="keyword">new</span> SelectorQuery(pluginId, <span class="keyword">new</span> PageParameter(currentPage, pageSize)));</span><br><span class="line">    <span class="keyword">return</span> SoulAdminResult.success(SoulResultMessage.QUERY_SUCCESS, commonPager);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‰ä¸¤ä¸ªè¯·æ±‚å…¶å®æ˜¯åœ¨åŠ è½½æˆ‘ä»¬å³ä¾§çš„é€‰æ‹©å™¨ï¼Œç°åœ¨æˆ‘ä»¬æ²¡æœ‰åˆ›å»ºé€‰æ‹©å™¨ï¼Œæ‰€ä»¥ä»€ä¹ˆä¹Ÿæ²¡æœ‰ã€‚<br>è€Œ /rule è¿™ä¸ªè¯·æ±‚æ˜¯åœ¨æŸ¥è¯¢ç°æœ‰çš„è§„åˆ™åˆ—è¡¨ã€‚</p>
<p>ç‚¹å‡»å³ä¾§çš„â€œåˆ›å»ºé€‰æ‹©å™¨â€æŒ‰é’®æ¥åˆ›å»ºé€‰æ‹©å™¨ï¼š<br><img src="https://img-blog.csdnimg.cn/20210115213000568.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dpY2tlZFdpbmdz,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>åˆ›å»ºå¥½é€‰æ‹©å™¨åï¼Œç”±äºæˆ‘ä»¬ä»…ä»…æ˜¯æŠŠé€‰æ‹©å™¨çš„æ•°æ®å­˜æ”¾åœ¨äº† æ•°æ®åº“ä¸­ï¼ˆæ ¹æ®ä½ é…ç½®å¯èƒ½åœ¨ MySQL æˆ– H2é‡Œï¼‰ï¼Œæˆ‘ä»¬å¦‚æœéœ€è¦ä»–å³æ—¶ç”Ÿæ•ˆéœ€è¦ç‚¹å‡»åŒæ­¥è‡ªå®šä¹‰rewriteã€‚<br><img src="https://img-blog.csdnimg.cn/20210115213237513.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dpY2tlZFdpbmdz,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>æ¥å£è°ƒç”¨è·¯å¾„æ˜¯</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:9095&#x2F;plugin&#x2F;syncPluginData&#x2F;3</span><br></pre></td></tr></table></figure>
<p>è¿”å› â€œsync successâ€ï¼Œæˆ‘ä»¬å†æ¬¡åˆ‡æ¢åˆ°æºç ï¼š<br><img src="https://img-blog.csdnimg.cn/20210115213635126.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dpY2tlZFdpbmdz,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>å‘ç° soul-admin ç”¨åˆ°äº†Spring ä¸­çš„ ApplicationEventPublisherï¼Œåœ¨å¦‚ä¸‹è·¯å¾„çš„ç±»ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿæ‰¾åˆ°äº†soul-adminå¤„ç†è¿™äº›æ—¶é—´çš„é€»è¾‘ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">org&#x2F;dromara&#x2F;soul&#x2F;admin&#x2F;listener&#x2F;DataChangedEventDispatcher.java</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20210115214219112.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dpY2tlZFdpbmdz,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>åˆšåˆšæˆ‘ä»¬åº”è¯¥æ˜¯é€šè¿‡ç‚¹å‡»æŒ‰é’®è§¦å‘äº† â€œonPluginChangedâ€ è¿™ä¸ªäº‹ä»¶ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œæ ¹æ®æˆ‘ä»¬æ‰€é…ç½®çš„æ•°æ®åŒæ­¥ä¾§å½•é¢ï¼Œsoul æä¾›äº†ä¸‰ç§å®ç°æ–¹å¼ï¼š<br><img src="https://img-blog.csdnimg.cn/20210115214458570.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dpY2tlZFdpbmdz,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ol>
<li><p>WebSocket<br> åœ¨ WebsocketDataChangedListener ä¸­è°ƒç”¨ onPluginChanged æ–¹æ³•æ¥å‘ SoulBootstrapApplication å‘é€JSONåºåˆ—åŒ–åçš„æ¶ˆæ¯ã€‚</p>
</li>
<li><p>Nacos<br> å¦‚æœé…ç½® Nacos è¿›è¡ŒåŒæ­¥ï¼Œåˆ™æ˜¯é€šè¿‡ ConfigService æ¥å‘é€æ¶ˆæ¯ã€‚</p>
 <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPluginChanged</span><span class="params">(<span class="keyword">final</span> List&lt;PluginData&gt; changed, <span class="keyword">final</span> DataEventTypeEnum eventType)</span> </span>&#123;</span><br><span class="line">     updatePluginMap(getConfig(PLUGIN_DATA_ID));</span><br><span class="line">     <span class="keyword">switch</span> (eventType) &#123;</span><br><span class="line">         <span class="keyword">case</span> DELETE:</span><br><span class="line">             changed.forEach(plugin -&gt; PLUGIN_MAP.remove(plugin.getName()));</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">         <span class="keyword">case</span> REFRESH:</span><br><span class="line">         <span class="keyword">case</span> MYSELF:</span><br><span class="line">             Set&lt;String&gt; set = <span class="keyword">new</span> HashSet&lt;&gt;(PLUGIN_MAP.keySet());</span><br><span class="line">             changed.forEach(plugin -&gt; &#123;</span><br><span class="line">                 set.remove(plugin.getName());</span><br><span class="line">                 PLUGIN_MAP.put(plugin.getName(), plugin);</span><br><span class="line">             &#125;);</span><br><span class="line">             PLUGIN_MAP.keySet().removeAll(set);</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">         <span class="keyword">default</span>:</span><br><span class="line">             changed.forEach(plugin -&gt; PLUGIN_MAP.put(plugin.getName(), plugin));</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     publishConfig(PLUGIN_DATA_ID, PLUGIN_MAP);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>ZooKeeper<br>  é€šè¿‡èŠ‚ç‚¹åŒæ­¥æ•°æ®ã€‚</p>
 <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPluginChanged</span><span class="params">(<span class="keyword">final</span> List&lt;PluginData&gt; changed, <span class="keyword">final</span> DataEventTypeEnum eventType)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">for</span> (PluginData data : changed) &#123;</span><br><span class="line">           <span class="keyword">final</span> String pluginPath = ZkPathConstants.buildPluginPath(data.getName());</span><br><span class="line">           <span class="comment">// delete</span></span><br><span class="line">           <span class="keyword">if</span> (eventType == DataEventTypeEnum.DELETE) &#123;</span><br><span class="line">               deleteZkPathRecursive(pluginPath);</span><br><span class="line">               <span class="keyword">final</span> String selectorParentPath = ZkPathConstants.buildSelectorParentPath(data.getName());</span><br><span class="line">               deleteZkPathRecursive(selectorParentPath);</span><br><span class="line">               <span class="keyword">final</span> String ruleParentPath = ZkPathConstants.buildRuleParentPath(data.getName());</span><br><span class="line">               deleteZkPathRecursive(ruleParentPath);</span><br><span class="line">               <span class="keyword">continue</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">//create or update</span></span><br><span class="line">           upsertZkNode(pluginPath, data);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥é€šè¿‡å¯¹æŒ‡å®šæ¥å£å‘èµ· POST è¯·æ±‚æ¥æ³¨å†Œå…¶ä»–è¯­è¨€çš„æœåŠ¡ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&quot;appName&quot;: &quot;xxx&quot;, &#x2F;&#x2F;åº”ç”¨åç§° å¿…å¡«</span><br><span class="line">	&quot;context&quot;: &quot;&#x2F;xxx&quot;, &#x2F;&#x2F;è¯·æ±‚å‰ç¼€ å¿…å¡«</span><br><span class="line">	&quot;path&quot;: &quot;xxx&quot;, &#x2F;&#x2F;è·¯å¾„éœ€è¦å”¯ä¸€ å¿…å¡«</span><br><span class="line">	&quot;pathDesc&quot;: &quot;xxx&quot;, &#x2F;&#x2F;è·¯å¾„æè¿°</span><br><span class="line">	&quot;rpcType&quot;: &quot;http&quot;, &#x2F;&#x2F;rpcç±»å‹  å¿…å¡«</span><br><span class="line">	&quot;host&quot;: &quot;xxx&quot;, &#x2F;&#x2F;æœåŠ¡host å¿…å¡«</span><br><span class="line">	&quot;port&quot;: xxx, &#x2F;&#x2F;æœåŠ¡ç«¯å£ å¿…å¡«</span><br><span class="line">	&quot;ruleName&quot;: &quot;xxx&quot;, &#x2F;&#x2F;å¯ä»¥åŒpathä¸€æ ·  å¿…å¡«</span><br><span class="line">	&quot;enabled&quot;: &quot;true&quot;, &#x2F;&#x2F;æ˜¯å¦å¼€å¯</span><br><span class="line">	&quot;registerMetaData&quot;: &quot;true&quot; &#x2F;&#x2F;æ˜¯å¦éœ€è¦æ³¨å†Œå…ƒæ•°æ®</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">è¯·æ±‚åœ°å€ï¼šhttp:&#x2F;&#x2F;&#123;ip&#125;:&#123;port&#125;&#x2F;soul-client&#x2F;springmvc-register è¯·è‡ªè¡Œè¾“å…¥soul-admin çš„ IP å’Œ PORT</span><br></pre></td></tr></table></figure>
<p>åœ¨ postman æˆ–å…¶ä»–å·¥å…·ä¸­æˆåŠŸæ³¨å†ŒæœåŠ¡ï¼š<br><img src="https://img-blog.csdnimg.cn/20210116013439579.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dpY2tlZFdpbmdz,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>ä½†æˆ‘ä»¬å‘ç°å¹¶ä¸èƒ½ç›´æ¥é€šè¿‡ soul æ¥ä»£ç†æˆ‘ä»¬çš„ flask æœåŠ¡ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">âœ  ~ curl http:&#x2F;&#x2F;localhost:9195</span><br><span class="line">&#123;&quot;code&quot;:-107,&quot;message&quot;:&quot;Can not find selector, please check your configuration!&quot;,&quot;data&quot;:null&#125;%</span><br></pre></td></tr></table></figure>
<p>ä»”ç»†æŸ¥çœ‹æ–‡æ¡£åï¼Œå‘ç°éœ€è¦å…ˆè®¾ç½® Divide æ’ä»¶å¹¶æ·»åŠ å¯¹åº”çš„selectorã€‚<br><img src="https://img-blog.csdnimg.cn/20210116014205816.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>é…ç½®å®Œæˆåå¯ä»¥çœ‹åˆ° divide æ’ä»¶æˆåŠŸé€‰å–åˆ°äº† æˆ‘ä»¬é…ç½®çš„ test1 selectorï¼Œä½†æ˜¯æˆ‘ä»¬çš„è¯·æ±‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:9195&#x2F;foo&#x2F;bar&#x2F;</span><br></pre></td></tr></table></figure>
<p>è¢«è§£ææˆäº† <a href="http://127.0.0.1:5000/bar/ï¼Œä¸€å®šæ˜¯ä»€ä¹ˆåœ°æ–¹å‡ºäº†é—®é¢˜ã€‚" target="_blank" rel="noopener">http://127.0.0.1:5000/bar/ï¼Œä¸€å®šæ˜¯ä»€ä¹ˆåœ°æ–¹å‡ºäº†é—®é¢˜ã€‚</a><br>å†çœ‹çœ‹æºç <br><img src="https://img-blog.csdnimg.cn/20210116015548504.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dpY2tlZFdpbmdz,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>æˆ‘ä»¬å‘ç° åœ¨ org/dromara/soul/plugin/divide/DividePlugin.java è¿™ä¸ªç±»ä¸­ buildRealURL ä¼šå°†æˆ‘ä»¬çš„ â€œ/fooâ€ è¯†åˆ«ä¸º moduleï¼Œç„¶åæŠŠâ€œ/barâ€ è¯†åˆ«ä¸ºçœŸå®çš„request pathï¼Œæ‰€ä»¥å¯¼è‡´äº†åˆšåˆšçš„é—®é¢˜ã€‚<br>å†æ¬¡å°è¯•åœ¨å‰é¢åŠ ä¸€å±‚ï¼ŒæˆåŠŸäº†ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">âœ  ~ curl http:&#x2F;&#x2F;localhost:9195&#x2F;1&#x2F;foo&#x2F;bar&#x2F;</span><br><span class="line">Hello World!%</span><br></pre></td></tr></table></figure>

</li>
</ol>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Soul</tag>
      </tags>
  </entry>
  <entry>
    <title>Vue.jsåŒå‘æ•°æ®ç»‘å®šæ¢ç©¶</title>
    <url>/2018/08/03/Vue-js%E5%8F%8C%E5%90%91%E6%95%B0%E6%8D%AE%E7%BB%91%E5%AE%9A%E6%8E%A2%E7%A9%B6/</url>
    <content><![CDATA[<p>åœ¨æœ€è¿‘çš„å‰ç«¯é¢è¯•ä¸­ï¼Œvue.jsçš„åŒå‘æ•°æ®ç»‘å®šåŸºæœ¬æ˜¯æˆ‘å¿…é—®çš„ã€‚ä¸‹é¢æˆ‘ä»¬å°±ä¸€èµ·æ¢ç©¶ä¸‹å…¶åŸç†ã€‚</p>
<a id="more"></a>

<p><img src="https://i.imgur.com/bKNikGl.jpg" alt=""></p>
<ol>
<li>åŸç†<br>Vue.jsåŒå‘æ•°æ®ç»‘å®šçš„åŸç†ä¸»è¦æ˜¯é€šè¿‡ <strong>Objectå¯¹è±¡çš„definePropertyæ–¹æ³•ï¼Œé‡å†™dataçš„setå’Œgetå‡½æ•°</strong> æ¥å®ç°çš„ã€‚<br>ä»¥ä¸‹æ˜¯defineProperty()çš„è¯­æ³•<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Object.defineProperty(obj, prop, descriptor)</span><br></pre></td></tr></table></figure>
è¿™ä¸ªæ–¹æ³•çš„ä¸‰ä¸ªå‚æ•°åˆ†åˆ«æ˜¯ï¼š</li>
</ol>
<ul>
<li>obj<br>è¦åœ¨å…¶ä¸Šå®šä¹‰å±æ€§çš„å¯¹è±¡ã€‚</li>
<li>prop<br>è¦å®šä¹‰æˆ–ä¿®æ”¹çš„å±æ€§çš„åç§°ã€‚</li>
<li>descriptor<br>å°†è¢«å®šä¹‰æˆ–ä¿®æ”¹çš„å±æ€§æè¿°ç¬¦ã€‚</li>
</ul>
<p>æ–¹æ³•ç›¸å…³çš„å°±ä¸åœ¨è¿™é‡Œè®¨è®ºï¼Œè¯¦è§ï¼š<br><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty" target="_blank" rel="noopener">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty</a></p>
]]></content>
      <categories>
        <category>frontend</category>
      </categories>
      <tags>
        <tag>Vue.js</tag>
      </tags>
  </entry>
  <entry>
    <title>hello_world</title>
    <url>/2018/04/15/hello-world/</url>
    <content><![CDATA[<h4 id="ç»ˆäºæœ‰äº†è‡ªå·±çš„åšå®¢äº†"><a href="#ç»ˆäºæœ‰äº†è‡ªå·±çš„åšå®¢äº†" class="headerlink" title="ç»ˆäºæœ‰äº†è‡ªå·±çš„åšå®¢äº†"></a>ç»ˆäºæœ‰äº†è‡ªå·±çš„åšå®¢äº†</h4>]]></content>
      <tags>
        <tag>mixture</tag>
      </tags>
  </entry>
  <entry>
    <title>mysqlç”Ÿæˆæ‰¹é‡è¯­å¥</title>
    <url>/2018/04/28/mysql%E7%94%9F%E6%88%90%E6%89%B9%E9%87%8F%E8%AF%AD%E5%8F%A5/</url>
    <content><![CDATA[<p>ä»Šå¤©é‡åˆ°ç›‘æ§ç³»ç»Ÿçš„è¡¨æ ¼å¤ªå¤šçš„é—®é¢˜, ä¸ºäº†èŠ‚çº¦æ—¶é—´, åœ¨ç½‘ä¸Šæ‰¾åˆ°äº†ç”Ÿæˆæ‰¹é‡åˆ é™¤è¡¨çš„è¯­å¥:</p>
<a id="more"></a>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT CONCAT( &#39;drop table &#39;, table_name, &#39;;&#39; )</span><br><span class="line">FROM information_schema.tables</span><br><span class="line">WHERE table_name LIKE &#39;pre_%&#39;;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·å¯ä»¥æ‰¹é‡ç”Ÿæˆdrop è¯­å¥, ä½¿ç”¨navicatæ‰§è¡Œå³å¯.</p>
<h3 id="è¡¥å……"><a href="#è¡¥å……" class="headerlink" title="è¡¥å……:"></a>è¡¥å……:</h3><p>ååˆ†é’Ÿäº†ç»“MySQL information_schema</p>
<p><a href="https://www.cnblogs.com/shengdimaya/p/6920677.html" target="_blank" rel="noopener">https://www.cnblogs.com/shengdimaya/p/6920677.html</a></p>
]]></content>
      <categories>
        <category>mysql</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>php åœ¨Windowså¼€å‘ä¸‹é‡åˆ°çš„å‘</title>
    <url>/2018/04/15/php-%E5%9C%A8Windows%E5%BC%80%E5%8F%91%E4%B8%8B%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91/</url>
    <content><![CDATA[<p>åœ¨æœ¬åœ°è°ƒè¯•phpé€šè¿‡ä½¿ç”¨phpçš„curl è°ƒç”¨Thrift rpc æœåŠ¡æ—¶, ä½¿ç”¨äº†curl, ä½†æ˜¯ä¸€ç›´å‡ºç°è¶…æ—¶çš„ç°è±¡,ä¸€ç›´åˆ°è¶…è¿‡è¯·æ±‚æ‰€é™„å¸¦çš„è¶…æ—¶æ—¶é—´, è¿™ä¸ªæ˜¯å› ä¸ºWindowsä¸‹çš„phpæ˜¯ä»¥php-cgiè¿›ç¨‹çš„å½¢å¼è¿è¡Œçš„.</p>
<a id="more"></a>

<p>æˆ‘çš„phpé¡¹ç›®çš„fastcig-passçš„è®¾ç½®ä¸º(127.0.0.1:9000)ã€‚</p>
<p>é»˜è®¤è®¾ç½®æ˜¯ä»¥keepaliveæ–¹å¼è¯·æ±‚ï¼Œæ¥æ”¶åˆ°PHPæ–‡ä»¶æ—¶,äº¤ä¸php-cgiè§£æå¤„ç†,ç­‰å¾…å“åº”ã€‚</p>
<p>è€Œåœ¨æœ¬åœ°æ–‡ä»¶ä»¥CURLè¯·æ±‚æœ¬åœ°ç¯å¢ƒä¸­PHPæ–‡ä»¶æ—¶,ä¹‹å‰çš„PHPè¿˜åœ¨ç­‰å¾…CURLåçš„ç»“æœï¼Œè¿™æ—¶9000ç«¯å£å·²ç»è¢«å ç”¨.å¯¼è‡´CURLä¸€ç›´åœ¨å¤„äºç­‰å¾…çŠ¶æ€.</p>
<p>curl å…¶ä¸­ä¸€é¡¹è®¾ç½®: </p>
<p>curl_setopt($ch, CURLOPT_TIMEOUT, 5);</p>
<p>å½“åˆ°è¾¾5ç§’å, curl è¢«å¼ºåˆ¶ä¸­æ–­, åè€Œæ”¶åˆ°äº†RPCä¼ æ¥çš„response</p>
<p>åœ¨æŸ¥é˜…èµ„æ–™å, æˆ‘å‘ç°Windows ä¸­php-cgiå¹¶ä¸èƒ½åƒLinuxç¯å¢ƒä¸‹çš„php-fpm é‚£æ ·è‡ªå·±åˆ›å»ºæ–°çš„è¿›ç¨‹, åªèƒ½é€šè¿‡commandçš„æ–¹å¼å¯åŠ¨ä¸¤ä¸ªè¿›ç¨‹â€¦</p>
<p><strong>æˆ‘çš„è§£å†³æ–¹æ¡ˆ</strong></p>
<p>æŠŠphpå®¢æˆ·ç«¯çš„fastcgi_pass è®¾ç½®ä¸ºäº†127.0.0.1:9004</p>
<p>æ‰“å¼€ä¸¤ä¸ªcmd åˆ†åˆ«åœ¨phpæ ¹ç›®å½•ä¸‹æ‰§è¡Œè¿™ä¸¤ä¸ªå‘½ä»¤:</p>
<ol>
<li>php-cgi.exe -b 127.0.0.1:9000 -c php.ini </li>
<li>php-cgi.exe -b 127.0.0.1:9004 -c php.ini </li>
</ol>
<p>ä½†æ˜¯cmd å‘½ä»¤çª—å£ä¸èƒ½å…³é—­ã€‚</p>
<p>é—®é¢˜è§£å†³.</p>
]]></content>
      <categories>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>PHP</tag>
        <tag>traps</tag>
      </tags>
  </entry>
  <entry>
    <title>Soul ç½‘å…³æºç åˆ†æï¼ˆä¸‰ï¼‰dubbo æ’ä»¶</title>
    <url>/2021/01/17/Soul-%E7%BD%91%E5%85%B3%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88%E4%B8%89%EF%BC%89dubbo-%E6%8F%92%E4%BB%B6/</url>
    <content><![CDATA[<p>åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°è¯•ä½¿ç”¨divideæ’ä»¶è¿›è¡Œhttpä»£ç†ï¼Œä»Šå¤©æˆ‘ä»¬æ¥çœ‹çœ‹Soulæ˜¯å¦‚ä½•å°†httpåè®®ï¼Œè½¬æ¢æˆdubboåè®®çš„ã€‚</p>
<a id="more"></a>

<p>é¦–å…ˆåœ¨æ’ä»¶ç®¡ç†ä¸­å¼€å¯dubboé…ç½®ï¼š<br><img src="https://img-blog.csdnimg.cn/20210117003330559.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dpY2tlZFdpbmdz,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>æ‰“å¼€Soul æºç ï¼Œç¼–è¯‘ä¸‹å›¾è·¯å¾„çš„dubbo demo é¡¹ç›®ï¼š<br><img src="https://img-blog.csdnimg.cn/20210117003428606.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dpY2tlZFdpbmdz,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>ç¼–è¯‘åæˆ‘ä»¬æŠŠæ‰“åŒ…å¥½çš„ Jar åŒ…runèµ·æ¥ï¼Œ<br>ç¡®ä¿</p>
<ol>
<li>dubbo æ’ä»¶å·²å¼€å¯</li>
<li>ä½ çš„soul-bootstrapï¼Œsoul-admin åœ¨è¿è¡ŒçŠ¶æ€</li>
<li>zookeeper ä¹Ÿåœ¨å¯åŠ¨çŠ¶æ€ï¼ˆé»˜è®¤ç«¯å£2181ï¼‰ï¼Œåœ°å€åœ¨ï¼š<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">soul&#x2F;soul-examples&#x2F;soul-examples-dubbo&#x2F;soul-examples-alibaba-dubbo-service&#x2F;target&#x2F;soul-examples-alibaba-dubbo-service-2.1.0.jar</span><br></pre></td></tr></table></figure>
æˆåŠŸè¿è¡Œdubbo demo åï¼Œå‘ç°soul admin å¸®æˆ‘ä»¬æ³¨å†Œäº†å…¶ä¸­çš„ endpoints<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2021-01-17 00:51:50.563  INFO 63416 --- [-47-EventThread] o.a.c.f.state.ConnectionStateManager     : State change: CONNECTED</span><br><span class="line">2021-01-17 00:51:50.590  INFO 63416 --- [-47-EventThread] o.a.c.framework.imps.EnsembleTracker     : New config event received: &#123;&#125;</span><br><span class="line">2021-01-17 00:51:50.590  INFO 63416 --- [-47-EventThread] o.a.c.framework.imps.EnsembleTracker     : New config event received: &#123;&#125;</span><br><span class="line">2021-01-17 00:51:50.973  INFO 63416 --- [ctReadThread-47] o.d.s.p.a.d.c.ApplicationConfigCache     : init aliaba dubbo reference success there meteData is :MetaData(id&#x3D;1350397137501040640, appName&#x3D;dubbo, contextPath&#x3D;null, path&#x3D;&#x2F;dubbo&#x2F;insert, rpcType&#x3D;dubbo, serviceName&#x3D;org.dromara.soul.examples.dubbo.api.service.DubboTestService, methodName&#x3D;insert, parameterTypes&#x3D;org.dromara.soul.examples.dubbo.api.entity.DubboTest, rpcExt&#x3D;&#123;&quot;group&quot;:&quot;&quot;,&quot;version&quot;:&quot;&quot;,&quot;loadbalance&quot;:&quot;random&quot;,&quot;retries&quot;:2,&quot;timeout&quot;:10000,&quot;url&quot;:&quot;&quot;&#125;, enabled&#x3D;true)</span><br><span class="line">2021-01-17 00:51:50.993  INFO 63416 --- [ctReadThread-47] o.d.s.p.a.d.c.ApplicationConfigCache     : init aliaba dubbo reference success there meteData is :MetaData(id&#x3D;1350397138167934976, appName&#x3D;dubbo, contextPath&#x3D;null, path&#x3D;&#x2F;dubbo&#x2F;findAll, rpcType&#x3D;dubbo, serviceName&#x3D;org.dromara.soul.examples.dubbo.api.service.DubboTestService, methodName&#x3D;findAll, parameterTypes&#x3D;null, rpcExt&#x3D;&#123;&quot;group&quot;:&quot;&quot;,&quot;version&quot;:&quot;&quot;,&quot;loadbalance&quot;:&quot;random&quot;,&quot;retries&quot;:2,&quot;timeout&quot;:10000,&quot;url&quot;:&quot;&quot;&#125;, enabled&#x3D;true)</span><br><span class="line">2021-01-17 00:51:51.012  INFO 63416 --- [ctReadThread-47] o.d.s.p.a.d.c.ApplicationConfigCache     : init aliaba dubbo reference success there meteData is :MetaData(id&#x3D;1350397138960658432, appName&#x3D;dubbo, contextPath&#x3D;null, path&#x3D;&#x2F;dubbo&#x2F;findById, rpcType&#x3D;dubbo, serviceName&#x3D;org.dromara.soul.examples.dubbo.api.service.DubboTestService, methodName&#x3D;findById, parameterTypes&#x3D;java.lang.String, rpcExt&#x3D;&#123;&quot;group&quot;:&quot;&quot;,&quot;version&quot;:&quot;&quot;,&quot;loadbalance&quot;:&quot;random&quot;,&quot;retries&quot;:2,&quot;timeout&quot;:10000,&quot;url&quot;:&quot;&quot;&#125;, enabled&#x3D;true)</span><br><span class="line">2021-01-17 00:51:51.060  INFO 63416 --- [ctReadThread-47] o.d.s.p.a.d.c.ApplicationConfigCache     : init aliaba dubbo reference success there meteData is :MetaData(id&#x3D;1350397139031961600, appName&#x3D;dubbo, contextPath&#x3D;null, path&#x3D;&#x2F;dubbo&#x2F;findByIdsAndName, rpcType&#x3D;dubbo, serviceName&#x3D;org.dromara.soul.examples.dubbo.api.service.DubboMultiParamService, methodName&#x3D;findByIdsAndName, parameterTypes&#x3D;java.util.List,java.lang.String, rpcExt&#x3D;&#123;&quot;group&quot;:&quot;&quot;,&quot;version&quot;:&quot;&quot;,&quot;loadbalance&quot;:&quot;random&quot;,&quot;retries&quot;:2,&quot;timeout&quot;:10000,&quot;url&quot;:&quot;&quot;&#125;, enabled&#x3D;true)</span><br><span class="line">2021-01-17 00:51:51.079  INFO 63416 --- [ctReadThread-47] o.d.s.p.a.d.c.ApplicationConfigCache     : init aliaba dubbo reference success there meteData is :MetaData(id&#x3D;1350397139103264768, appName&#x3D;dubbo, contextPath&#x3D;null, path&#x3D;&#x2F;dubbo&#x2F;findByArrayIdsAndName, rpcType&#x3D;dubbo, serviceName&#x3D;org.dromara.soul.examples.dubbo.api.service.DubboMultiParamService, methodName&#x3D;findByArrayIdsAndName, parameterTypes&#x3D;[Ljava.lang.Integer;,java.lang.String, rpcExt&#x3D;&#123;&quot;group&quot;:&quot;&quot;,&quot;version&quot;:&quot;&quot;,&quot;loadbalance&quot;:&quot;random&quot;,&quot;retries&quot;:2,&quot;timeout&quot;:10000,&quot;url&quot;:&quot;&quot;&#125;, enabled&#x3D;true)</span><br><span class="line">2021-01-17 00:51:51.100  INFO 63416 --- [ctReadThread-47] o.d.s.p.a.d.c.ApplicationConfigCache     : init aliaba dubbo reference success there meteData is :MetaData(id&#x3D;1350397139182956544, appName&#x3D;dubbo, contextPath&#x3D;null, path&#x3D;&#x2F;dubbo&#x2F;findByStringArray, rpcType&#x3D;dubbo, serviceName&#x3D;org.dromara.soul.examples.dubbo.api.service.DubboMultiParamService, methodName&#x3D;findByStringArray, parameterTypes&#x3D;[Ljava.lang.String;, rpcExt&#x3D;&#123;&quot;group&quot;:&quot;&quot;,&quot;version&quot;:&quot;&quot;,&quot;loadbalance&quot;:&quot;random&quot;,&quot;retries&quot;:2,&quot;timeout&quot;:10000,&quot;url&quot;:&quot;&quot;&#125;, enabled&#x3D;true)</span><br><span class="line">2021-01-17 00:51:51.126  INFO 63416 --- [ctReadThread-47] o.d.s.p.a.d.c.ApplicationConfigCache     : init aliaba dubbo reference success there meteData is :MetaData(id&#x3D;1350397139258454016, appName&#x3D;dubbo, contextPath&#x3D;null, path&#x3D;&#x2F;dubbo&#x2F;findByListId, rpcType&#x3D;dubbo, serviceName&#x3D;org.dromara.soul.examples.dubbo.api.service.DubboMultiParamService, methodName&#x3D;findByListId, parameterTypes&#x3D;java.util.List, rpcExt&#x3D;&#123;&quot;group&quot;:&quot;&quot;,&quot;version&quot;:&quot;&quot;,&quot;loadbalance&quot;:&quot;random&quot;,&quot;retries&quot;:2,&quot;timeout&quot;:10000,&quot;url&quot;:&quot;&quot;&#125;, enabled&#x3D;true)</span><br><span class="line">2021-01-17 00:51:51.153  INFO 63416 --- [ctReadThread-47] o.d.s.p.a.d.c.ApplicationConfigCache     : init aliaba dubbo reference success there meteData is :MetaData(id&#x3D;1350397139346534400, appName&#x3D;dubbo, contextPath&#x3D;null, path&#x3D;&#x2F;dubbo&#x2F;batchSave, rpcType&#x3D;dubbo, serviceName&#x3D;org.dromara.soul.examples.dubbo.api.service.DubboMultiParamService, methodName&#x3D;batchSave, parameterTypes&#x3D;java.util.List, rpcExt&#x3D;&#123;&quot;group&quot;:&quot;&quot;,&quot;version&quot;:&quot;&quot;,&quot;loadbalance&quot;:&quot;random&quot;,&quot;retries&quot;:2,&quot;timeout&quot;:10000,&quot;url&quot;:&quot;&quot;&#125;, enabled&#x3D;true)</span><br><span class="line">2021-01-17 00:51:51.169  INFO 63416 --- [ctReadThread-47] o.d.s.p.a.d.c.ApplicationConfigCache     : init aliaba dubbo reference success there meteData is :MetaData(id&#x3D;1350397139413643264, appName&#x3D;dubbo, contextPath&#x3D;null, path&#x3D;&#x2F;dubbo&#x2F;batchSaveAndNameAndId, rpcType&#x3D;dubbo, serviceName&#x3D;org.dromara.soul.examples.dubbo.api.service.DubboMultiParamService, methodName&#x3D;batchSaveAndNameAndId, parameterTypes&#x3D;java.util.List,java.lang.String,java.lang.String, rpcExt&#x3D;&#123;&quot;group&quot;:&quot;&quot;,&quot;version&quot;:&quot;&quot;,&quot;loadbalance&quot;:&quot;random&quot;,&quot;retries&quot;:2,&quot;timeout&quot;:10000,&quot;url&quot;:&quot;&quot;&#125;, enabled&#x3D;true)</span><br><span class="line">2021-01-17 00:51:51.186  INFO 63416 --- [ctReadThread-47] o.d.s.p.a.d.c.ApplicationConfigCache     : init aliaba dubbo reference success there meteData is :MetaData(id&#x3D;1350397139476557824, appName&#x3D;dubbo, contextPath&#x3D;null, path&#x3D;&#x2F;dubbo&#x2F;saveComplexBeanTest, rpcType&#x3D;dubbo, serviceName&#x3D;org.dromara.soul.examples.dubbo.api.service.DubboMultiParamService, methodName&#x3D;saveComplexBeanTest, parameterTypes&#x3D;org.dromara.soul.examples.dubbo.api.entity.ComplexBeanTest, rpcExt&#x3D;&#123;&quot;group&quot;:&quot;&quot;,&quot;version&quot;:&quot;&quot;,&quot;loadbalance&quot;:&quot;random&quot;,&quot;retries&quot;:2,&quot;timeout&quot;:10000,&quot;url&quot;:&quot;&quot;&#125;, enabled&#x3D;true)</span><br><span class="line">2021-01-17 00:51:51.201  INFO 63416 --- [ctReadThread-47] o.d.s.p.a.d.c.ApplicationConfigCache     : init aliaba dubbo reference success there meteData is :MetaData(id&#x3D;1350397139547860992, appName&#x3D;dubbo, contextPath&#x3D;null, path&#x3D;&#x2F;dubbo&#x2F;saveComplexBeanTestAndName, rpcType&#x3D;dubbo, serviceName&#x3D;org.dromara.soul.examples.dubbo.api.service.DubboMultiParamService, methodName&#x3D;saveComplexBeanTestAndName, parameterTypes&#x3D;org.dromara.soul.examples.dubbo.api.entity.ComplexBeanTest,java.lang.String, rpcExt&#x3D;&#123;&quot;group&quot;:&quot;&quot;,&quot;version&quot;:&quot;&quot;,&quot;loadbalance&quot;:&quot;random&quot;,&quot;retries&quot;:2,&quot;timeout&quot;:10000,&quot;url&quot;:&quot;&quot;&#125;, enabled&#x3D;true)</span><br></pre></td></tr></table></figure>
ä½¿ç”¨curl è°ƒç”¨ soul-bootstrap ä»£ç†çš„æ¥å£ï¼š<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl localhost:9195&#x2F;dubbo&#x2F;findAll </span><br><span class="line">&#x2F;&#x2F;è¿”å›äº†</span><br><span class="line">&#123;&quot;code&quot;:200,&quot;message&quot;:&quot;Access to success!&quot;,&quot;data&quot;:&#123;&quot;name&quot;:&quot;hello world Soul Alibaba Dubbo , findAll&quot;,&quot;id&quot;:&quot;654524173&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>
è¡¨æ˜æˆ‘ä»¬é€šè¿‡soulæˆåŠŸè°ƒç”¨äº†dubboçš„æ¥å£ã€‚</li>
</ol>
<p>æ·±å…¥æºç ï¼Œåœ¨è°ƒç”¨ â€œ/dubbo/findAllâ€ è¿™ä¸ªè·¯å¾„æ—¶ï¼Œdubbo plugin æ‰§è¡Œäº† doExecute æ–¹æ³•ï¼Œç„¶åä» ServerWebExchange ä¸­åˆ†åˆ«è·å–åˆ°äº†<br>soulContext å’Œ metaDataï¼š<br><img src="https://img-blog.csdnimg.cn/202101170117309.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dpY2tlZFdpbmdz,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br><img src="https://img-blog.csdnimg.cn/20210117011809380.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dpY2tlZFdpbmdz,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>åœ¨è¿™ä¸¤ä¸ªå¯¹è±¡ä¸­æˆ‘ä»¬å·²ç»çœ‹åˆ°äº†å³å°†è°ƒç”¨åˆ°çš„DubboTestServiceå’Œ å¯¹åº”çš„æ–¹æ³•å findAllã€‚<br>åœ¨è¿™é‡Œæˆ‘ä»¬è·å–åˆ°äº† genericServiceï¼Œå¹¶å°†å°è£…å¥½çš„æ–¹æ³•åï¼Œå‚æ•°é€šè¿‡ genericService çš„ $invokeæ–¹æ³•è°ƒç”¨çœŸå®çš„dubboæœåŠ¡endpointï¼Œå†å°†response è¿”å›ç»™soul-bootstrapè¿™è¾¹ã€‚<br><img src="https://img-blog.csdnimg.cn/20210117012348487.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dpY2tlZFdpbmdz,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>æ€»ç»“ï¼šDubboæ’ä»¶éå¸¸å¼ºå¤§ï¼Œèƒ½å¤Ÿé€šè¿‡æ‰«æzookeeperçš„æ–¹å¼å°†æ‰€æœ‰å·²æ³¨å†Œçš„endpoint å¹¶ç›´æ¥æ·»åŠ åˆ°è§„åˆ™ä¸­ï¼Œè¿™ä¸€ç‚¹å¯¹äºdubboç”¨æˆ·æ¥è¯´æ¥å…¥å‡ ä¹æ˜¯é›¶æˆæœ¬çš„ã€‚</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Soul</tag>
      </tags>
  </entry>
  <entry>
    <title>Soul ç½‘å…³æºç åˆ†æï¼ˆå››ï¼‰sign æ’ä»¶</title>
    <url>/2021/01/19/Soul-%E7%BD%91%E5%85%B3%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89sign-%E6%8F%92%E4%BB%B6/</url>
    <content><![CDATA[<p>åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°è¯•dubboæ’ä»¶å°†httpåè®®è½¬æ¢æˆdubboåè®®ï¼Œä»Šå¤©æˆ‘ä»¬æ¥çœ‹çœ‹ sign æ’ä»¶æ˜¯å¦‚ä½•å®ç°è¯·æ±‚é‰´æƒçš„ã€‚</p>
<a id="more"></a>
<h1 id="æµç¨‹æ¼”ç¤º"><a href="#æµç¨‹æ¼”ç¤º" class="headerlink" title="æµç¨‹æ¼”ç¤º"></a>æµç¨‹æ¼”ç¤º</h1><p>æˆ‘ä»¬å…ˆè¯•è¯•æ²¡æœ‰æ·»åŠ signæ’ä»¶æ—¶ï¼Œæ˜¯å¦èƒ½æ­£å¸¸è¯·æ±‚æ¥å£ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">âœ  ~ curl localhost:9195&#x2F;dubbo&#x2F;findAll</span><br><span class="line">&#123;&quot;code&quot;:200,&quot;message&quot;:&quot;Access to success!&quot;,&quot;data&quot;:&#123;&quot;name&quot;:&quot;hello world Soul Alibaba Dubbo , findAll&quot;,&quot;id&quot;:&quot;-803129909&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>æˆåŠŸã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦åœ¨æ’ä»¶ç®¡ç†ä¸­æ‰“å¼€signæ’ä»¶çš„å¼€å…³ã€‚ç„¶åæˆ‘ä»¬åœ¨è®¤è¯ç®¡ç†ä¸­ï¼Œæ–°å¢ä¸€æ¡ AK/SK è®°å½•ï¼š<br><img src="https://img-blog.csdnimg.cn/20210119004613292.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dpY2tlZFdpbmdz,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>æ·»åŠ å®Œæ¯•åï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°AppKey å’ŒåŠ å¯†å¯†é’¥å·²ç»ä¸ºæˆ‘ä»¬ç”Ÿæˆå¥½äº†ï¼š<br><img src="https://img-blog.csdnimg.cn/20210119004712413.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dpY2tlZFdpbmdz,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>ç°åœ¨æˆ‘ä»¬å†è¯•è¯•åˆšåˆšä»£ç†dubbo æœåŠ¡ä¸­çš„ /dubbo/findAll æ¥å£ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">âœ  ~ curl localhost:9195&#x2F;dubbo&#x2F;findAll</span><br><span class="line">&#123;&quot;code&quot;:200,&quot;message&quot;:&quot;Access to success!&quot;,&quot;data&quot;:&#123;&quot;name&quot;:&quot;hello world Soul Alibaba Dubbo , findAll&quot;,&quot;id&quot;:&quot;-541002115&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>å‘ç°æ²¡æœ‰ç”Ÿæ•ˆï¼ŒåŸå› æ˜¯æ²¡æœ‰é…ç½®signçš„é€‰æ‹©å™¨ï¼š<br><img src="https://img-blog.csdnimg.cn/20210119010246549.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dpY2tlZFdpbmdz,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br><img src="https://img-blog.csdnimg.cn/2021011901033031.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dpY2tlZFdpbmdz,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br><img src="https://img-blog.csdnimg.cn/20210119010334975.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dpY2tlZFdpbmdz,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>æŒ‰ç…§ä¸Šå›¾æ‰€ç¤ºé…ç½®å¥½signé€‰æ‹©å™¨åå†è¯·æ±‚æˆ‘ä»¬é…ç½®äº†é‰´æƒæ ¡éªŒçš„æ¥å£ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">âœ  ~ curl localhost:9195&#x2F;dubbo&#x2F;findAll</span><br><span class="line">&#123;&quot;code&quot;:401,&quot;message&quot;:&quot;sign parameters are incomplete!&quot;,&quot;data&quot;:null&#125;</span><br></pre></td></tr></table></figure>
<p>æˆäº†ï¼Œæç¤ºæˆ‘ä»¬ç­¾åå‚æ•°ä¸å®Œæ•´ï¼Œä¸‹è¡¨å±•ç¤ºäº†æˆ‘ä»¬éœ€è¦åœ¨headersä¸­æ·»åŠ çš„headerï¼š</p>
<table>
<thead>
<tr>
<th>å­—æ®µ</th>
<th>å€¼</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>timestamp</td>
<td>1571711067186</td>
<td>ä¸Šè¿°ä½ è¿›è¡Œç­¾åçš„æ—¶å€™ä½¿ç”¨çš„æ—¶é—´å€¼</td>
</tr>
<tr>
<td>appKey</td>
<td>1TEST123456781</td>
<td>AKå€¼</td>
</tr>
<tr>
<td>sign</td>
<td>A90E66763793BDBC817CF3B52AAAC041</td>
<td>ä¸Šè¿°å¾—åˆ°çš„ç­¾åå€¼</td>
</tr>
<tr>
<td>version</td>
<td>1.0.0</td>
<td>å›ºå®šé»˜è®¤å€¼</td>
</tr>
<tr>
<td>ç­¾åæ’ä»¶ä¼šé»˜è®¤è¿‡æ»¤5åˆ†é’Ÿä¹‹åçš„è¯·æ±‚ã€‚</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>ç°åœ¨ç›´å¥”å•å…ƒæµ‹è¯•ç±»ï¼ŒæŠŠç°æœ‰çš„æ—¶é—´æˆ³ï¼Œappkey å’Œ sign æ”¹å†™æˆè‡ªå·±çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> SignService signService;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">private</span> ServerWebExchange exchange;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">//è¿™é‡Œæ”¹æˆè‡ªå·±çš„</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> String appKey = <span class="string">"E841FEDBF8EE4912878993EC84F70947"</span>;</span><br><span class="line">   <span class="comment">//è¿™é‡Œæ”¹æˆè‡ªå·±çš„</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> String secretKey = <span class="string">"4FBB99E1B97B45D79D8F891D45DBB97E"</span>;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">private</span> SoulContext passed;</span><br><span class="line">   </span><br><span class="line">   <span class="meta">@Value</span>(<span class="string">"$&#123;soul.sign.delay:5&#125;"</span>)</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">int</span> delay;</span><br><span class="line">   </span><br><span class="line">   <span class="meta">@Before</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>.signService = <span class="keyword">new</span> DefaultSignService();</span><br><span class="line">       <span class="keyword">this</span>.exchange = MockServerWebExchange.from(MockServerHttpRequest.get(<span class="string">"localhost"</span>).build());</span><br><span class="line">       <span class="comment">//è¿™é‡Œæ”¹æˆè‡ªå·±çš„ï¼Œè·¯å¾„æ˜¯é»˜è®¤ç­¾åçš„ä¸€éƒ¨åˆ†</span></span><br><span class="line">       <span class="keyword">final</span> String path = <span class="string">"/dubbo/findAll"</span>;</span><br><span class="line">       PluginData signData = <span class="keyword">new</span> PluginData();</span><br><span class="line">       signData.setId(<span class="string">"1"</span>);</span><br><span class="line">       signData.setName(PluginEnum.SIGN.getName());</span><br><span class="line">       signData.setEnabled(<span class="keyword">true</span>);</span><br><span class="line">       signData.setRole(<span class="number">1</span>);</span><br><span class="line">       BaseDataCache.getInstance().cachePluginData(signData);</span><br><span class="line">       </span><br><span class="line">       AppAuthData authData = <span class="keyword">new</span> AppAuthData();</span><br><span class="line">       authData.setAppKey(appKey);</span><br><span class="line">       authData.setAppSecret(secretKey);</span><br><span class="line">       authData.setEnabled(<span class="keyword">true</span>);</span><br><span class="line">       AuthPathData authPathData = <span class="keyword">new</span> AuthPathData();</span><br><span class="line">       authPathData.setAppName(<span class="string">"test-api"</span>);</span><br><span class="line">       authPathData.setPath(path);</span><br><span class="line">       authPathData.setEnabled(<span class="keyword">true</span>);</span><br><span class="line">       authData.setPathDataList(Lists.newArrayList(authPathData));</span><br><span class="line">       SignAuthDataCache.getInstance().cacheAuthData(authData);</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">this</span>.passed = <span class="keyword">new</span> SoulContext();</span><br><span class="line">       <span class="keyword">this</span>.passed.setModule(<span class="string">"/dubbo"</span>);</span><br><span class="line">       <span class="keyword">this</span>.passed.setMethod(<span class="string">"/findAll"</span>);</span><br><span class="line">       <span class="keyword">this</span>.passed.setRpcType(<span class="string">"dubbo"</span>);</span><br><span class="line">       <span class="keyword">this</span>.passed.setHttpMethod(<span class="string">"GET"</span>);</span><br><span class="line">       <span class="keyword">this</span>.passed.setPath(path);</span><br><span class="line">       <span class="keyword">final</span> String timestamp = String.valueOf(System.currentTimeMillis());</span><br><span class="line">       <span class="keyword">this</span>.passed.setTimestamp(timestamp);</span><br><span class="line">       <span class="keyword">this</span>.passed.setSign(buildSign(secretKey, timestamp, <span class="keyword">this</span>.passed.getPath()));</span><br><span class="line">       <span class="comment">//åœ¨è¿™é‡Œæ‰“æ–­ç‚¹ï¼Œè·å–åˆ° this.getpassed ä¸­çš„sign</span></span><br><span class="line">       <span class="keyword">this</span>.passed.setAppKey(appKey);</span><br><span class="line">       <span class="keyword">this</span>.passed.setContextPath(<span class="string">"/"</span>);</span><br><span class="line">       <span class="keyword">this</span>.passed.setRealUrl(<span class="string">"/dubbo/findAll"</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢æˆ‘ä»¬åœ¨postman è¯·æ±‚çš„ headers ä¸­æ·»åŠ ç­¾åç›¸å…³çš„headerå¹¶è¯·æ±‚ï¼š<br><img src="https://img-blog.csdnimg.cn/20210119012826823.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dpY2tlZFdpbmdz,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>æˆåŠŸé€šè¿‡äº†æ ¡éªŒã€‚</p>
<h1 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The type Default sign service.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xiaoyu</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultSignService</span> <span class="keyword">implements</span> <span class="title">SignService</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å¯ä»¥è‡ªå®šä¹‰signè¿‡æœŸæ—¶é—´ï¼Œå•ä½ä¸ºåˆ†é’Ÿ</span></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;soul.sign.delay:5&#125;"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> delay;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Pair&lt;Boolean, String&gt; <span class="title">signVerify</span><span class="params">(<span class="keyword">final</span> ServerWebExchange exchange)</span> </span>&#123;</span><br><span class="line">        PluginData signData = BaseDataCache.getInstance().obtainPluginData(PluginEnum.SIGN.getName());</span><br><span class="line">        <span class="comment">//éœ€è¦é…ç½® sign æ’ä»¶ä¸” sign æ’ä»¶æ˜¯æ¿€æ´»çŠ¶æ€</span></span><br><span class="line">        <span class="keyword">if</span> (signData != <span class="keyword">null</span> &amp;&amp; signData.getEnabled()) &#123;</span><br><span class="line">            <span class="keyword">final</span> SoulContext soulContext = exchange.getAttribute(Constants.CONTEXT);</span><br><span class="line">            <span class="keyword">assert</span> soulContext != <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">//æ‰§è¡Œverifyæ–¹æ³•æ ¡éªŒç­¾å</span></span><br><span class="line">            <span class="keyword">return</span> verify(soulContext, exchange);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Pair.of(Boolean.TRUE, <span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> Pair&lt;Boolean, String&gt; <span class="title">verify</span><span class="params">(<span class="keyword">final</span> SoulContext soulContext, <span class="keyword">final</span> ServerWebExchange exchange)</span> </span>&#123;</span><br><span class="line">    	<span class="comment">//ä»»æ„ä¸ºç©ºï¼Œåˆ™å¤±è´¥</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(soulContext.getAppKey())</span><br><span class="line">                || StringUtils.isBlank(soulContext.getSign())</span><br><span class="line">                || StringUtils.isBlank(soulContext.getTimestamp())) &#123;</span><br><span class="line">            log.error(<span class="string">"sign parameters are incomplete,&#123;&#125;"</span>, soulContext);</span><br><span class="line">            <span class="keyword">return</span> Pair.of(Boolean.FALSE, Constants.SIGN_PARAMS_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//è·å–å½“å‰çš„æ—¶é—´æˆ³</span></span><br><span class="line">        <span class="keyword">final</span> LocalDateTime start = DateUtils.formatLocalDateTimeFromTimestampBySystemTimezone(Long.parseLong(soulContext.getTimestamp()));</span><br><span class="line">        <span class="keyword">final</span> LocalDateTime now = LocalDateTime.now();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> between = DateUtils.acquireMinutesBetween(start, now);</span><br><span class="line">        <span class="comment">//è·Ÿdelayåšæ¯”å¯¹</span></span><br><span class="line">        <span class="keyword">if</span> (between &gt; delay) &#123;</span><br><span class="line">            <span class="keyword">return</span> Pair.of(Boolean.FALSE, String.format(SoulResultEnum.SING_TIME_IS_TIMEOUT.getMsg(), delay));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sign(soulContext, exchange);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * verify sign .</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> soulContext &#123;<span class="doctag">@linkplain</span> SoulContext&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> result : True is pass, False is not pass.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Pair&lt;Boolean, String&gt; <span class="title">sign</span><span class="params">(<span class="keyword">final</span> SoulContext soulContext, <span class="keyword">final</span> ServerWebExchange exchange)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> AppAuthData appAuthData = SignAuthDataCache.getInstance().obtainAuthData(soulContext.getAppKey());</span><br><span class="line">        <span class="comment">//ä¸€ç³»åˆ—åˆ¤ç©ºé€»è¾‘</span></span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(appAuthData) || !appAuthData.getEnabled()) &#123;</span><br><span class="line">            log.error(<span class="string">"sign APP_kEY does not exist or has been disabled,&#123;&#125;"</span>, soulContext.getAppKey());</span><br><span class="line">            <span class="keyword">return</span> Pair.of(Boolean.FALSE, Constants.SIGN_APP_KEY_IS_NOT_EXIST);</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;AuthPathData&gt; pathDataList = appAuthData.getPathDataList();</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(pathDataList)) &#123;</span><br><span class="line">            log.error(<span class="string">"You have not configured the sign path:&#123;&#125;"</span>, soulContext.getAppKey());</span><br><span class="line">            <span class="keyword">return</span> Pair.of(Boolean.FALSE, Constants.SIGN_PATH_NOT_EXIST);</span><br><span class="line">        &#125;</span><br><span class="line">   		<span class="comment">//æŸ¥çœ‹pathæ˜¯å¦åœ¨é…ç½®åˆ—è¡¨ä¸­</span></span><br><span class="line">        <span class="keyword">boolean</span> match = pathDataList.stream().filter(AuthPathData::getEnabled)</span><br><span class="line">                .anyMatch(e -&gt; PathMatchUtils.match(e.getPath(), soulContext.getPath()));</span><br><span class="line">        <span class="keyword">if</span> (!match) &#123;</span><br><span class="line">            log.error(<span class="string">"You have not configured the sign path:&#123;&#125;,&#123;&#125;"</span>, soulContext.getAppKey(), soulContext.getRealUrl());</span><br><span class="line">            <span class="keyword">return</span> Pair.of(Boolean.FALSE, Constants.SIGN_PATH_NOT_EXIST);</span><br><span class="line">        &#125;</span><br><span class="line">        String sigKey = SignUtils.generateSign(appAuthData.getAppSecret(), buildParamsMap(soulContext));</span><br><span class="line">        <span class="keyword">boolean</span> result = Objects.equals(sigKey, soulContext.getSign());</span><br><span class="line">        <span class="comment">//æ ¡éªŒsignæ˜¯å¦åˆæ³•</span></span><br><span class="line">        <span class="keyword">if</span> (!result) &#123;</span><br><span class="line">            log.error(<span class="string">"the SignUtils generated signature value is:&#123;&#125;,the accepted value is:&#123;&#125;"</span>, sigKey, soulContext.getSign());</span><br><span class="line">            <span class="keyword">return</span> Pair.of(Boolean.FALSE, Constants.SIGN_VALUE_IS_ERROR);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            List&lt;AuthParamData&gt; paramDataList = appAuthData.getParamDataList();</span><br><span class="line">            <span class="keyword">if</span> (CollectionUtils.isEmpty(paramDataList)) &#123;</span><br><span class="line">                <span class="keyword">return</span> Pair.of(Boolean.TRUE, <span class="string">""</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            paramDataList.stream().filter(p -&gt;</span><br><span class="line">                    (<span class="string">"/"</span> + p.getAppName()).equals(soulContext.getContextPath()))</span><br><span class="line">                    .map(AuthParamData::getAppParam)</span><br><span class="line">                    .filter(StringUtils::isNoneBlank).findFirst()</span><br><span class="line">                    .ifPresent(param -&gt; exchange.getRequest().mutate().headers(httpHeaders -&gt; httpHeaders.set(Constants.APP_PARAM, param)).build()</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Pair.of(Boolean.TRUE, <span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> Map&lt;String, String&gt; <span class="title">buildParamsMap</span><span class="params">(<span class="keyword">final</span> SoulContext dto)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, String&gt; map = Maps.newHashMapWithExpectedSize(<span class="number">3</span>);</span><br><span class="line">        map.put(Constants.TIMESTAMP, dto.getTimestamp());</span><br><span class="line">        map.put(Constants.PATH, dto.getPath());</span><br><span class="line">        map.put(Constants.VERSION, <span class="string">"1.0.0"</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>å…¶å®ç­¾åæ’ä»¶çš„æ ¸å¿ƒé€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å®ç°äº† sign ã€ verifyç­‰æ–¹æ³•ï¼Œå†å®ç° SignService æ¥å£çš„ signVerifyå‡½æ•°å®Œæˆæ•´ä¸ªç­¾åçš„æµç¨‹ã€‚å¦‚æœæœ‰éœ€è¦æˆ‘ä»¬å¯ä»¥åŠ å…¥è‡ªå·±çš„ç­¾åæ ¡éªŒé€»è¾‘ï¼Œæ¯”å¦‚ç”¨JWTä¹‹ç±»çš„æ¥å®ç°ï¼Œåªéœ€è¦å®ç° SignService æ¥å£çš„ signVerify å³å¯ã€‚</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Soul</tag>
      </tags>
  </entry>
  <entry>
    <title>Soul ç½‘å…³æºç åˆ†æï¼ˆäº”ï¼‰Spring Cloud æ’ä»¶ï¼ˆä¸€ï¼‰</title>
    <url>/2021/01/19/Soul-%E7%BD%91%E5%85%B3%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88%E4%BA%94%EF%BC%89Spring-Cloud-%E6%8F%92%E4%BB%B6%EF%BC%88%E4%B8%80%EF%BC%89/</url>
    <content><![CDATA[<p>ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬å­¦ä¹ äº† sign æ’ä»¶æ˜¯å¦‚ä½•å®ç°è¯·æ±‚é‰´æƒçš„ï¼Œä»Šå¤©æˆ‘ä»¬æ¥è¯•è¯• Soul çš„Spring Cloud æ’ä»¶ã€‚</p>
<a id="more"></a>
<h2 id="æµç¨‹æ¼”ç¤º"><a href="#æµç¨‹æ¼”ç¤º" class="headerlink" title="æµç¨‹æ¼”ç¤º"></a>æµç¨‹æ¼”ç¤º</h2><p>å…ˆè§£é™¤soul-bootstrap Spring Cloud ä¾èµ–éƒ¨åˆ†çš„å¦‚ä¸‹æ³¨é‡Šï¼š</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">        <span class="comment">&lt;!--soul springCloud plugin start--&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.dromara<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>soul-spring-boot-starter-plugin-springcloud<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-ribbon<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--soul springCloud plugin start end--&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- springCloud if you config register center is nacos please dependency this--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;dependency&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;version&gt;2.1.0.RELEASE&lt;/version&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;/dependency&gt;--&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- springCloud if you config register center is eureka please dependency end--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Spring Cloud æ’ä»¶æ”¯æŒ Nacos æˆ–è€… Eurekaä½œä¸ºæœåŠ¡æ³¨å†Œä¸­çš„ï¼Œè¿™ä¸€æ¬¡æˆ‘ä»¬é€‰æ‹©Eurekaã€‚</p>
<p>åœ¨ soul-bootstrap çš„ application.yml ä¸­æ·»åŠ Eureka ç›¸å…³ä¾èµ–ï¼š</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8761/eureka/</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>åœ¨ soul-admin ä¸­å¼€å¯Spring Cloud æ’ä»¶æ”¯æŒã€‚<br><img src="https://img-blog.csdnimg.cn/20210119224248721.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>ç›´æ¥å¯åŠ¨ soul-examples-springcloud å’Œ soul-examples-eurekaï¼Œæ‰“å¼€Eurekaçš„é¡µé¢å¯ä»¥çœ‹åˆ°å·²ç»æŠŠæˆ‘ä»¬çš„åº”ç”¨æ³¨å†Œå¥½äº†ã€‚<br><img src="https://img-blog.csdnimg.cn/2021011922585019.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dpY2tlZFdpbmdz,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>å†å›åˆ° soul-adminï¼Œå‘ç°æˆ‘ä»¬çš„ Spring Cloud æœåŠ¡çš„ç›¸å…³ endpoints å·²ç»åŠ åˆ°äº†é€‰æ‹©å™¨å’Œè§„åˆ™åˆ—è¡¨ä¸­ï¼š<br><img src="https://img-blog.csdnimg.cn/20210119230144991.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dpY2tlZFdpbmdz,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>æ¥ä¸‹æ¥æˆ‘ä»¬ç”¨ curl æ¥æµ‹è¯•ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">âœ  ~ curl &quot;localhost:9195&#x2F;springcloud&#x2F;order&#x2F;findById?id&#x3D;1&quot;</span><br><span class="line">&#123;&quot;id&quot;:&quot;1&quot;,&quot;name&quot;:&quot;hello world spring cloud findById&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>æˆåŠŸè¿”å›æ•°æ®ã€‚ç°åœ¨æˆ‘ä»¬ä½¿ç”¨wrkæ‰§è¡Œä¸€ä¸‹å‹æµ‹ï¼Œä»¥ä¸‹æ˜¯ä¸é€‚ç”¨soulç½‘å…³</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">âœ  ~ wrk -t8 -c200 -d30s --latency  &quot;http:&#x2F;&#x2F;localhost:8884&#x2F;order&#x2F;findById?id&#x3D;1&quot;</span><br><span class="line">Running 30s test @ http:&#x2F;&#x2F;localhost:8884&#x2F;order&#x2F;findById?id&#x3D;1</span><br><span class="line">  8 threads and 200 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +&#x2F;- Stdev</span><br><span class="line">    Latency     8.21ms    6.05ms 155.20ms   92.54%</span><br><span class="line">    Req&#x2F;Sec     2.95k   703.14    15.51k    79.58%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%    7.27ms</span><br><span class="line">     75%    9.19ms</span><br><span class="line">     90%   11.65ms</span><br><span class="line">     99%   33.06ms</span><br><span class="line">  700305 requests in 30.07s, 119.00MB read</span><br><span class="line">Requests&#x2F;sec:  23285.91</span><br><span class="line">Transfer&#x2F;sec:      3.96MB</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨soulç½‘å…³</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">âœ  ~ wrk -t8 -c200 -d30s --latency  &quot;http:&#x2F;&#x2F;localhost:9195&#x2F;springcloud&#x2F;order&#x2F;findById?id&#x3D;1&quot;</span><br><span class="line">Running 30s test @ http:&#x2F;&#x2F;localhost:9195&#x2F;springcloud&#x2F;order&#x2F;findById?id&#x3D;1</span><br><span class="line">  8 threads and 200 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +&#x2F;- Stdev</span><br><span class="line">    Latency    47.59ms   37.60ms 294.45ms   80.29%</span><br><span class="line">    Req&#x2F;Sec   592.92    129.17     0.97k    70.40%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%   36.84ms</span><br><span class="line">     75%   61.51ms</span><br><span class="line">     90%   99.43ms</span><br><span class="line">     99%  176.76ms</span><br><span class="line">  141697 requests in 30.10s, 28.13MB read</span><br><span class="line">Requests&#x2F;sec:   4707.18</span><br><span class="line">Transfer&#x2F;sec:      0.93MB</span><br></pre></td></tr></table></figure>
<p>å¯èƒ½è·Ÿç¬”è€…æœºå™¨æœ‰å…³ï¼Œç½‘å…³åœ¨8ä¸ªçº¿ç¨‹200ä¸ªè¿æ¥æµ‹è¯•30ç§’çš„æƒ…å†µï¼Œå»¶è¿Ÿæœ‰æ¯”è¾ƒæ˜æ˜¾çš„æå‡ï¼Œåˆæ­¥æ€€ç–‘å—åˆ°äº†æ—¥å¿—è¾“å‡ºçš„å½±å“ï¼Œè°ƒæ•´æ—¥å¿—è¾“å‡ºçº§åˆ«åå†è¿›è¡Œæµ‹è¯•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">âœ  ~ wrk -t8 -c200 -d30s --latency  &quot;http:&#x2F;&#x2F;localhost:9195&#x2F;springcloud&#x2F;order&#x2F;findById?id&#x3D;1&quot;</span><br><span class="line">Running 30s test @ http:&#x2F;&#x2F;localhost:9195&#x2F;springcloud&#x2F;order&#x2F;findById?id&#x3D;1</span><br><span class="line">  8 threads and 200 connections</span><br><span class="line">^C  Thread Stats   Avg      Stdev     Max   +&#x2F;- Stdev</span><br><span class="line">    Latency    39.94ms   26.08ms 218.19ms   71.90%</span><br><span class="line">    Req&#x2F;Sec   657.54    122.81     0.91k    78.91%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%   35.04ms</span><br><span class="line">     75%   53.40ms</span><br><span class="line">     90%   74.22ms</span><br><span class="line">     99%  122.25ms</span><br><span class="line">  33581 requests in 6.44s, 6.67MB read</span><br><span class="line">Requests&#x2F;sec:   5214.23</span><br><span class="line">Transfer&#x2F;sec:      1.04MB</span><br></pre></td></tr></table></figure>
<p>è®¾ç½®æ—¥å¿—è¾“å‡ºçº§åˆ«ä¸ºerroråæ€§èƒ½æŸè€—è¦å°ä¸€äº›ã€‚</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Soul</tag>
      </tags>
  </entry>
  <entry>
    <title>Soul ç½‘å…³æºç åˆ†æï¼ˆå…­ï¼‰ä½¿ç”¨websocketåŒæ­¥æ•°æ®åˆ°ç½‘å…³</title>
    <url>/2021/01/21/Soul-%E7%BD%91%E5%85%B3%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88%E5%85%AD%EF%BC%89%E4%BD%BF%E7%94%A8websocket%E5%90%8C%E6%AD%A5%E6%95%B0%E6%8D%AE%E5%88%B0%E7%BD%91%E5%85%B3/</url>
    <content><![CDATA[<p>Soul æä¾›äº†å¤šç§æ•°æ®åŒæ­¥çš„ç­–ç•¥ï¼Œé»˜è®¤ä¸”æ¨èçš„æ–¹å¼æ˜¯ä½¿ç”¨ websocketã€‚ä¸ºäº†è¿½æ±‚æè‡´çš„å“åº”é€Ÿåº¦ï¼Œæ‰€æœ‰çš„é…ç½®æ²¡æœ‰é€‰æ‹©å­˜åˆ°redisï¼ŒMySQLæˆ–æ˜¯å…¶ä»–å­˜å‚¨æ–¹å¼ä¸­ï¼Œè€Œæ˜¯ç›´æ¥åœ¨HashMapä¸­ç¼“å­˜ï¼Œå¯ä»¥è¾¾åˆ°æä½çš„å»¶è¿Ÿã€‚</p>
<a id="more"></a>
<p>ä¸‹å›¾æ˜¯ä¸‰ç§ç­–ç•¥ä¸‹ï¼ŒSoul ç½‘å…³ä¸ soul-admin æ•°æ®åŒæ­¥çš„æµç¨‹ï¼š<br><img src="https://img-blog.csdnimg.cn/20210121001006462.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dpY2tlZFdpbmdz,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>å€ŸåŠ©websocketçš„ç‰¹æ€§ï¼ŒDataChangedEventDispatcher å¾—ä»¥ä¸»åŠ¨å‘ Soul ç½‘å…³æ¨é€æ•°æ®å˜æ›´ã€‚å½“ soul-admin ä¸ soul-bootstrap é¦–æ¬¡å»ºç«‹è¿æ¥æ—¶ï¼Œä¼šå‘soul-bootstrap æ¨é€ä¸€æ¬¡å…¨é‡çš„é…ç½®æ•°æ®ï¼Œå¢é‡çš„æ•°æ®ä¹Ÿå¯ä»¥ç”± soul-admin ä¸»åŠ¨æ¨é€ç»™ soul-bootstrapã€‚</p>
<p>soul-admin ä¼šæ ¹æ®é…ç½®åŠ è½½ä»¥ä¸‹çš„ beanï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The WebsocketListener(default strategy).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty</span>(name = <span class="string">"soul.sync.websocket.enabled"</span>, havingValue = <span class="string">"true"</span>, matchIfMissing = <span class="keyword">true</span>)</span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span>(WebsocketSyncProperties<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">static</span> <span class="title">class</span> <span class="title">WebsocketListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç›‘å¬æ•°æ®å˜åŒ–çš„listener.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the data changed listener</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span>(WebsocketDataChangedListener<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">DataChangedListener</span> <span class="title">websocketDataChangedListener</span>() </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> WebsocketDataChangedListener();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * websocketæœåŠ¡ç«¯ï¼Œè´Ÿè´£websocket æ•°æ®çš„ OnOpenï¼ŒOnMessageï¼ŒOnCloseï¼ŒOnErrorç­‰ç”Ÿå‘½å‘¨æœŸçš„å¤„ç†å’Œæ•°æ®æ¨é€ã€‚</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the websocket collector</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span>(WebsocketCollector<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">WebsocketCollector</span> <span class="title">websocketCollector</span>() </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> WebsocketCollector();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Server endpoint exporter server endpoint exporter.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the server endpoint exporter</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span>(ServerEndpointExporter<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">ServerEndpointExporter</span> <span class="title">serverEndpointExporter</span>() </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ServerEndpointExporter();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ï¼ŒWebsocketDataChangedListener å°è£…äº†å¯¹ä¸€ç³»åˆ—æ•°æ®çš„ç›‘å¬ï¼Œä»¥æ’ä»¶å˜æ›´ç›‘å¬ä¸ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPluginChanged</span><span class="params">(<span class="keyword">final</span> List&lt;PluginData&gt; pluginDataList, <span class="keyword">final</span> DataEventTypeEnum eventType)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// å…ˆå°è£… websocket æ•°æ®ï¼Œå†ä½¿ç”¨ WebsocketCollector æ¥å‘é€jsonåºåˆ—åŒ–åçš„æ•°æ®åˆ° soul-bootstrap.</span></span><br><span class="line">    WebsocketData&lt;PluginData&gt; websocketData =</span><br><span class="line">            <span class="keyword">new</span> WebsocketData&lt;&gt;(ConfigGroupEnum.PLUGIN.name(), eventType.name(), pluginDataList);</span><br><span class="line">    WebsocketCollector.send(GsonUtils.getInstance().toJson(websocketData), eventType);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The type Websocket data changed listener.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xiaoyu(Myth)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> huangxiaofeng</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.0.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@ServerEndpoint</span>(<span class="string">"/websocket"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebsocketCollector</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;Session&gt; SESSION_SET = <span class="keyword">new</span> CopyOnWriteArraySet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SESSION_KEY = <span class="string">"sessionKey"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** ç•¥ **/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * On message.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message the message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> session the session</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@OnMessage</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(<span class="keyword">final</span> String message, <span class="keyword">final</span> Session session)</span> </span>&#123;</span><br><span class="line">    	<span class="comment">// åªæœ‰ message çš„ç±»å‹æ˜¯ MYSELFæ—¶æ‰å¤„ç†</span></span><br><span class="line">        <span class="keyword">if</span> (message.equals(DataEventTypeEnum.MYSELF.name())) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">            	<span class="comment">//å°† websocket session ä¿å­˜åˆ° ThreadLocal ä¸­ã€‚</span></span><br><span class="line">                ThreadLocalUtil.put(SESSION_KEY, session);</span><br><span class="line">                </span><br><span class="line">                SpringBeanUtils.getInstance().getBean(SyncDataService<span class="class">.<span class="keyword">class</span>).<span class="title">syncAll</span>(<span class="title">DataEventTypeEnum</span>.<span class="title">MYSELF</span>)</span>;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                ThreadLocalUtil.clear();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Send.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message the message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type    the type</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(<span class="keyword">final</span> String message, <span class="keyword">final</span> DataEventTypeEnum type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(message)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DataEventTypeEnum.MYSELF == type) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Session session = (Session) ThreadLocalUtil.get(SESSION_KEY);</span><br><span class="line">                    <span class="keyword">if</span> (session != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        session.getBasicRemote().sendText(message);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    log.error(<span class="string">"websocket send result is exception: "</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//å‘æ‰€æœ‰å­˜åœ¨çš„session å‘é€æ¶ˆæ¯</span></span><br><span class="line">            <span class="keyword">for</span> (Session session : SESSION_SET) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    session.getBasicRemote().sendText(message);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    log.error(<span class="string">"websocket send result is exception: "</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å½“ DataEventTypeEnum æ˜¯ MYSELF æ—¶ï¼Œä¹Ÿå°±æ˜¯å®¢æˆ·ç«¯å‘æ¥ MYSELF æ¶ˆæ¯æ—¶ï¼ŒæœåŠ¡ç«¯ä¼šæŠŠæ‰€æœ‰çš„é…ç½®æ•°æ®åŒæ­¥ç»™å®¢æˆ·ç«¯ï¼Œå…·ä½“çš„ä»£ç å®ç°åœ¨ WebsocketSyncDataConfiguration è¿™ä¸ªç±»åŠ è½½ã€åˆ›å»º WebsocketSyncDataService bean æ—¶ï¼Œåœ¨ WebsocketSyncDataService ç±»ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebsocketSyncDataService</span> <span class="keyword">implements</span> <span class="title">SyncDataService</span>, <span class="title">AutoCloseable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;WebSocketClient&gt; clients = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ScheduledThreadPoolExecutor executor;</span><br><span class="line">    </span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">WebsocketSyncDataService</span><span class="params">(<span class="keyword">final</span> WebsocketConfig websocketConfig,</span></span></span><br><span class="line"><span class="function"><span class="params">	                                    <span class="keyword">final</span> PluginDataSubscriber pluginDataSubscriber,</span></span></span><br><span class="line"><span class="function"><span class="params">	                                    <span class="keyword">final</span> List&lt;MetaDataSubscriber&gt; metaDataSubscribers,</span></span></span><br><span class="line"><span class="function"><span class="params">	                                    <span class="keyword">final</span> List&lt;AuthDataSubscriber&gt; authDataSubscribers)</span> </span>&#123;</span><br><span class="line">	        String[] urls = StringUtils.split(websocketConfig.getUrls(), <span class="string">","</span>);</span><br><span class="line">	        executor = <span class="keyword">new</span> ScheduledThreadPoolExecutor(urls.length, SoulThreadFactory.create(<span class="string">"websocket-connect"</span>, <span class="keyword">true</span>));</span><br><span class="line">	        <span class="keyword">for</span> (String url : urls) &#123;</span><br><span class="line">	            <span class="keyword">try</span> &#123;</span><br><span class="line">	            	<span class="comment">//éå†æ‰€æœ‰urlï¼Œå°† SoulWebsocketClient å®ä¾‹åŠ åˆ° clientsä¸­</span></span><br><span class="line">	                clients.add(<span class="keyword">new</span> SoulWebsocketClient(<span class="keyword">new</span> URI(url), Objects.requireNonNull(pluginDataSubscriber), metaDataSubscribers, authDataSubscribers));</span><br><span class="line">	            &#125; <span class="keyword">catch</span> (URISyntaxException e) &#123;</span><br><span class="line">	                log.error(<span class="string">"websocket url(&#123;&#125;) is error"</span>, url, e);</span><br><span class="line">	            &#125;</span><br><span class="line">	        &#125;</span><br><span class="line">        <span class="comment">/** ç•¥ **/</span></span><br></pre></td></tr></table></figure>
<p>è€Œåœ¨å®ä¾‹åŒ– SoulWebsocketClientæ—¶ï¼Œä¼šè°ƒç”¨å¦‚ä¸‹çš„å‡½æ•°ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onOpen</span><span class="params">(<span class="keyword">final</span> ServerHandshake serverHandshake)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">if</span> (!alreadySync) &#123;</span><br><span class="line">         send(DataEventTypeEnum.MYSELF.name());</span><br><span class="line">         alreadySync = <span class="keyword">true</span>;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>clientä¼šåœ¨ websocket open çš„æ—¶å€™ å‘é€ MYSELF æ¶ˆæ¯åˆ°æœåŠ¡ç«¯ï¼ŒéªŒè¯äº†ä¸Šé¢æˆ‘ä»¬çš„æƒ³æ³•ã€‚å…¶ä»–ç±»å‹çš„ DataEventTypeEnum å‘é€åˆ™æ˜¯é€šè¿‡ onMessage å¤„ç†ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>soul å·§å¦™å¾—è¿ç”¨äº† websocket è¿›è¡Œæ•°æ®åŒæ­¥ï¼Œå°†æ•°æ®ç›´æ¥æ”¾åˆ°JVMçš„æ–¹æ³•ä¹Ÿä½“ç°äº†å¯¹æ€§èƒ½çš„æè‡´è¿½æ±‚ã€‚</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Soul</tag>
      </tags>
  </entry>
  <entry>
    <title>Soul ç½‘å…³æºç åˆ†æï¼ˆä¸ƒï¼‰ä½¿ç”¨zookeeperåŒæ­¥æ•°æ®åˆ°ç½‘å…³</title>
    <url>/2021/01/22/Soul-%E7%BD%91%E5%85%B3%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88%E4%B8%83%EF%BC%89%E4%BD%BF%E7%94%A8zookeeper%E5%90%8C%E6%AD%A5%E6%95%B0%E6%8D%AE%E5%88%B0%E7%BD%91%E5%85%B3/</url>
    <content><![CDATA[<p>ä¸ websocket æ•°æ®åŒæ­¥æ–¹å¼ç±»ä¼¼ï¼Œé‡‡ç”¨ zookeeper çš„åŒæ­¥ä¹Ÿå¾ˆç®€å•ï¼Œ ç”±äº zookeeper çš„ watch æœºåˆ¶ï¼Œsou-bootstrap ä¼šç›‘å¬é…ç½®çš„nodeï¼Œsoul-admin åœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œä¹Ÿä¼šè·Ÿwebsockerä¸€æ ·å°†æ•°æ®å…¨é‡å†™å…¥ zookeeperã€‚æ•°æ®å‘ç”Ÿå˜æ›´æ—¶ï¼Œä¼šå¯¹zookeeper çš„èŠ‚ç‚¹åšå¢é‡æ›´æ–° ï¼Œå¹¶æ›´æ–°æœ¬åœ°ç¼“å­˜ã€‚</p>
<a id="more"></a>
<h2 id="æµç¨‹æ¼”ç¤º"><a href="#æµç¨‹æ¼”ç¤º" class="headerlink" title="æµç¨‹æ¼”ç¤º"></a>æµç¨‹æ¼”ç¤º</h2><p>é¦–å…ˆå¯åŠ¨zookeeperï¼Œç¬”è€…ä½¿ç”¨ docker å¯åŠ¨ã€‚</p>
<p>æ¨èä½¿ç”¨ ZooInspector æ¥ç›´è§‚åœ°çœ‹åˆ° zookeeper ä¸­èŠ‚ç‚¹çš„æ•°æ®ã€‚<br>ä¸‹è½½åœ°å€ï¼š<br><a href="https://issues.apache.org/jira/secure/attachment/12436620/ZooInspector.zip" target="_blank" rel="noopener">https://issues.apache.org/jira/secure/attachment/12436620/ZooInspector.zip</a><br>ä½¿ç”¨æ–¹æ³•ï¼š<br>åœ¨build æ–‡ä»¶å¤¹ä¸‹æ‰§è¡Œ java -jar zookeeper-dev-ZooInspector.jar</p>
<p>ä¸‹é¢æˆ‘ä»¬æ¥ä¿®æ”¹ç›¸å…³çš„é…ç½®ä½¿ç”¨ zookeeperæ¥åŒæ­¥æ•°æ®ã€‚å…ˆæ”¹ soul-bootstrapçš„é…ç½®ï¼š</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">soul :</span></span><br><span class="line">    <span class="attr">file:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">corss:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">dubbo :</span></span><br><span class="line">      <span class="attr">parameter:</span> <span class="string">multi</span></span><br><span class="line">    <span class="attr">sync:</span></span><br><span class="line"><span class="comment">#        websocket :</span></span><br><span class="line"><span class="comment">#             urls: ws://localhost:9095/websocket</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">zookeeper:</span></span><br><span class="line">             <span class="attr">url:</span> <span class="string">localhost:2181</span></span><br><span class="line">             <span class="attr">sessionTimeout:</span> <span class="number">5000</span></span><br><span class="line">             <span class="attr">connectionTimeout:</span> <span class="number">2000</span></span><br></pre></td></tr></table></figure>
<p>å†æ”¹soul-admin çš„é…ç½®ï¼š</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">soul:</span></span><br><span class="line">  <span class="attr">database:</span></span><br><span class="line">    <span class="attr">dialect:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">init_script:</span> <span class="string">"META-INF/schema.sql"</span></span><br><span class="line">    <span class="attr">init_enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">sync:</span></span><br><span class="line"><span class="comment">#    websocket:</span></span><br><span class="line"><span class="comment">#      enabled: true</span></span><br><span class="line">      <span class="attr">zookeeper:</span></span><br><span class="line">          <span class="attr">url:</span> <span class="string">localhost:2181</span></span><br><span class="line">          <span class="attr">sessionTimeout:</span> <span class="number">5000</span></span><br><span class="line">          <span class="attr">connectionTimeout:</span> <span class="number">2000</span></span><br></pre></td></tr></table></figure>
<p>æ³¨é‡Šæ‰websocket ä¸‹çš„é…ç½®å¹¶è§£é™¤æ³¨é‡Š zookeeper ç›¸å…³é…ç½®ã€‚<br>å¯åŠ¨ soul-bootstrap å’Œ soul-admin<br>å¯ä»¥çœ‹åˆ° æ•°æ® å·²ç»å†™å…¥äº† zookeeper<br><img src="https://img-blog.csdnimg.cn/2021012200570892.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dpY2tlZFdpbmdz,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>å°è¯•ä¿®æ”¹æ•°æ®ï¼š<br><img src="https://img-blog.csdnimg.cn/20210122005942345.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dpY2tlZFdpbmdz,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>å‘ç°ä¸€ä¸ªå¥‡æ€ªçš„bugï¼Œè·Ÿåˆ°æºç å‘ç°äº†é—®é¢˜ï¼Œå–œæissueï¼š<br><img src="https://img-blog.csdnimg.cn/20210122010015709.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dpY2tlZFdpbmdz,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br><img src="https://img-blog.csdnimg.cn/20210122011324157.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dpY2tlZFdpbmdz,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>é‡æ–°æ·»åŠ  selectorï¼Œå†ç‚¹å‡»åŒæ­¥ï¼ŒæˆåŠŸåŒæ­¥åˆ°äº†zookeeperã€‚</p>
<h2 id="æ·±å…¥æºç "><a href="#æ·±å…¥æºç " class="headerlink" title="æ·±å…¥æºç "></a>æ·±å…¥æºç </h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The type Zookeeper listener.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="meta">@ConditionalOnProperty</span>(prefix = <span class="string">"soul.sync.zookeeper"</span>, name = <span class="string">"url"</span>)</span><br><span class="line">    <span class="meta">@Import</span>(ZookeeperConfiguration<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">static</span> <span class="title">class</span> <span class="title">ZookeeperListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * è¿™é‡Œå¦‚æœå¼€å¯äº†zookeeperç›¸å…³é…ç½®ï¼Œä¼šåŠ è½½ ZookeeperDataChangedListener beanã€‚</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> zkClient the zk client</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> the data changed listener</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="meta">@ConditionalOnMissingBean</span>(ZookeeperDataChangedListener<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">        <span class="title">public</span> <span class="title">DataChangedListener</span> <span class="title">zookeeperDataChangedListener</span>(<span class="title">final</span> <span class="title">ZkClient</span> <span class="title">zkClient</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ZookeeperDataChangedListener(zkClient);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * è´Ÿè´£åŒæ­¥åˆå§‹åŒ–æ•°æ®ã€‚</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> zkClient        the zk client</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> syncDataService the sync data service</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> the zookeeper data init</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="meta">@ConditionalOnMissingBean</span>(ZookeeperDataInit<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">        <span class="title">public</span> <span class="title">ZookeeperDataInit</span> <span class="title">zookeeperDataInit</span>(<span class="title">final</span> <span class="title">ZkClient</span> <span class="title">zkClient</span>, <span class="title">final</span> <span class="title">SyncDataService</span> <span class="title">syncDataService</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ZookeeperDataInit(zkClient, syncDataService);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶åæ˜¯ ZookeeperDataChangedListenerä¸­å¯¹åº”äº‹ä»¶ç›‘å¬å¤„ç†çš„é€»è¾‘ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZookeeperDataChangedListener</span> <span class="keyword">implements</span> <span class="title">DataChangedListener</span> </span>&#123;</span><br><span class="line">	<span class="comment">//zookeeper å®¢æˆ·ç«¯</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ZkClient zkClient;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ZookeeperDataChangedListener</span><span class="params">(<span class="keyword">final</span> ZkClient zkClient)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.zkClient = zkClient;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//ç›‘å¬åˆ° åº”ç”¨é‰´æƒå˜æ›´</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAppAuthChanged</span><span class="params">(<span class="keyword">final</span> List&lt;AppAuthData&gt; changed, <span class="keyword">final</span> DataEventTypeEnum eventType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (AppAuthData data : changed) &#123;</span><br><span class="line">            <span class="keyword">final</span> String appAuthPath = ZkPathConstants.buildAppAuthPath(data.getAppKey());</span><br><span class="line">            <span class="comment">// delete</span></span><br><span class="line">            <span class="keyword">if</span> (eventType == DataEventTypeEnum.DELETE) &#123;</span><br><span class="line">                deleteZkPath(appAuthPath);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// create or update</span></span><br><span class="line">            upsertZkNode(appAuthPath, data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//ç›‘å¬åˆ° å…ƒæ•°æ®å˜æ›´</span></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMetaDataChanged</span><span class="params">(<span class="keyword">final</span> List&lt;MetaData&gt; changed, <span class="keyword">final</span> DataEventTypeEnum eventType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (MetaData data : changed) &#123;</span><br><span class="line">            <span class="keyword">final</span> String metaDataPath = ZkPathConstants.buildMetaDataPath(URLEncoder.encode(data.getPath(), <span class="string">"UTF-8"</span>));</span><br><span class="line">            <span class="comment">// delete</span></span><br><span class="line">            <span class="keyword">if</span> (eventType == DataEventTypeEnum.DELETE) &#123;</span><br><span class="line">                deleteZkPath(metaDataPath);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// create or update</span></span><br><span class="line">            upsertZkNode(metaDataPath, data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//ç›‘å¬åˆ° æ’ä»¶å˜æ›´</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPluginChanged</span><span class="params">(<span class="keyword">final</span> List&lt;PluginData&gt; changed, <span class="keyword">final</span> DataEventTypeEnum eventType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (PluginData data : changed) &#123;</span><br><span class="line">            <span class="keyword">final</span> String pluginPath = ZkPathConstants.buildPluginPath(data.getName());</span><br><span class="line">            <span class="comment">// delete</span></span><br><span class="line">            <span class="keyword">if</span> (eventType == DataEventTypeEnum.DELETE) &#123;</span><br><span class="line">            	<span class="comment">//å…ˆåˆ é™¤å†æ›´æ–°</span></span><br><span class="line">                deleteZkPathRecursive(pluginPath);</span><br><span class="line">                <span class="keyword">final</span> String selectorParentPath = ZkPathConstants.buildSelectorParentPath(data.getName());</span><br><span class="line">                deleteZkPathRecursive(selectorParentPath);</span><br><span class="line">                <span class="keyword">final</span> String ruleParentPath = ZkPathConstants.buildRuleParentPath(data.getName());</span><br><span class="line">                deleteZkPathRecursive(ruleParentPath);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//create or update</span></span><br><span class="line">            upsertZkNode(pluginPath, data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//ç›‘å¬åˆ° é€‰æ‹©å™¨å˜æ›´</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSelectorChanged</span><span class="params">(<span class="keyword">final</span> List&lt;SelectorData&gt; changed, <span class="keyword">final</span> DataEventTypeEnum eventType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (eventType == DataEventTypeEnum.REFRESH) &#123;</span><br><span class="line">            <span class="keyword">final</span> String selectorParentPath = ZkPathConstants.buildSelectorParentPath(changed.get(<span class="number">0</span>).getPluginName());</span><br><span class="line">            deleteZkPathRecursive(selectorParentPath);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (SelectorData data : changed) &#123;</span><br><span class="line">            <span class="keyword">final</span> String selectorRealPath = ZkPathConstants.buildSelectorRealPath(data.getPluginName(), data.getId());</span><br><span class="line">            <span class="keyword">if</span> (eventType == DataEventTypeEnum.DELETE) &#123;</span><br><span class="line">                deleteZkPath(selectorRealPath);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">final</span> String selectorParentPath = ZkPathConstants.buildSelectorParentPath(data.getPluginName());</span><br><span class="line">            createZkNode(selectorParentPath);</span><br><span class="line">            <span class="comment">//create or update</span></span><br><span class="line">            upsertZkNode(selectorRealPath, data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//ç›‘å¬åˆ° è§„åˆ™å˜æ›´</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRuleChanged</span><span class="params">(<span class="keyword">final</span> List&lt;RuleData&gt; changed, <span class="keyword">final</span> DataEventTypeEnum eventType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (eventType == DataEventTypeEnum.REFRESH) &#123;</span><br><span class="line">            <span class="keyword">final</span> String selectorParentPath = ZkPathConstants.buildRuleParentPath(changed.get(<span class="number">0</span>).getPluginName());</span><br><span class="line">            deleteZkPathRecursive(selectorParentPath);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (RuleData data : changed) &#123;</span><br><span class="line">            <span class="keyword">final</span> String ruleRealPath = ZkPathConstants.buildRulePath(data.getPluginName(), data.getSelectorId(), data.getId());</span><br><span class="line">            <span class="keyword">if</span> (eventType == DataEventTypeEnum.DELETE) &#123;</span><br><span class="line">                deleteZkPath(ruleRealPath);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">final</span> String ruleParentPath = ZkPathConstants.buildRuleParentPath(data.getPluginName());</span><br><span class="line">            createZkNode(ruleParentPath);</span><br><span class="line">            <span class="comment">//create or update</span></span><br><span class="line">            upsertZkNode(ruleRealPath, data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åˆ›å»ºèŠ‚ç‚¹</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createZkNode</span><span class="params">(<span class="keyword">final</span> String path)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!zkClient.exists(path)) &#123;</span><br><span class="line">            zkClient.createPersistent(path, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æœ‰åˆ™æ›´æ–°ã€æ— åˆ™åˆ›å»ºèŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> path node path</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data node data </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">upsertZkNode</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> Object data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!zkClient.exists(path)) &#123;</span><br><span class="line">            zkClient.createPersistent(path, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        zkClient.writeData(path, data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åˆ é™¤è·¯å¾„</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">deleteZkPath</span><span class="params">(<span class="keyword">final</span> String path)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (zkClient.exists(path)) &#123;</span><br><span class="line">            zkClient.delete(path);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//é€’å½’åˆ é™¤</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">deleteZkPathRecursive</span><span class="params">(<span class="keyword">final</span> String path)</span> </span>&#123; </span><br><span class="line">        <span class="keyword">if</span> (zkClient.exists(path)) &#123;</span><br><span class="line">            zkClient.deleteRecursive(path);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>zookeeper çš„åŒæ­¥æ–¹å¼ç›¸å¯¹ä¸websocket æ€§èƒ½ä¸Šå·®è·åº”è¯¥ä¸å¤§ï¼Œå®ç°åŸç†ä¹Ÿç±»ä¼¼ï¼Œæ¯”è¾ƒéº»çƒ¦çš„æ˜¯éœ€è¦ç»´æŠ¤ zookeeperï¼Œè€Œä½¿ç”¨ websocket åˆ™æ²¡æœ‰è¿™æ ·çš„é—®é¢˜ã€‚</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Soul</tag>
      </tags>
  </entry>
  <entry>
    <title>Soul ç½‘å…³æºç åˆ†æï¼ˆå…«ï¼‰ä½¿ç”¨ http é•¿è½®è¯¢åŒæ­¥æ•°æ®åˆ°ç½‘å…³</title>
    <url>/2021/01/23/Soul-%E7%BD%91%E5%85%B3%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88%E5%85%AB%EF%BC%89%E4%BD%BF%E7%94%A8-http-%E9%95%BF%E8%BD%AE%E8%AF%A2%E5%90%8C%E6%AD%A5%E6%95%B0%E6%8D%AE%E5%88%B0%E7%BD%91%E5%85%B3/</url>
    <content><![CDATA[<p>ä»Šå¤©æˆ‘ä»¬ä½¿ç”¨ httpé•¿è½®è¯¢æ¥åŒæ­¥æ•°æ®åˆ°soul-bootstrapï¼Œç›¸æ¯”websocketæ–¹å¼æ›´ä¸ºè½»é‡ï¼Œä½†åŒæ—¶æ—¶æ•ˆæ€§ä¼šç•¥ä¸ºé™ä½ã€‚é¦–å…ˆæˆ‘ä»¬æ¥çœ‹çœ‹ä»€ä¹ˆæ˜¯httpé•¿è½®è¯¢ã€‚</p>
<a id="more"></a>
<p>çŸ­è¿æ¥ï¼šclientæ¯å‘serverå‘èµ·ä¸€æ¬¡httpè¯·æ±‚ï¼Œå°±å»ºç«‹ä¸€ä¸ªtpcè¿æ¥ï¼Œä»»åŠ¡ç»“æŸåˆ™ä¸­æ–­ã€‚</p>
<p>åœ¨httpé•¿è½®è¯¢æœºåˆ¶ä¸­ï¼Œclientä¸€æ ·å‘serverè¯·æ±‚æ•°æ®ã€‚ç„¶è€Œï¼Œå¦‚æœserveræ²¡æœ‰å¯ä»¥ç«‹å³è¿”å›ç»™clientçš„æ•°æ®ï¼Œåˆ™ä¸ä¼šç«‹åˆ»è¿”å›ä¸€ä¸ªç©ºç»“æœï¼Œè€Œæ˜¯ä¿æŒè¿™ä¸ªè¯·æ±‚ç­‰å¾…æ•°æ®åˆ°æ¥ï¼ˆæˆ–è€…æ°å½“çš„è¶…æ—¶ï¼šå°äºajaxçš„è¶…æ—¶æ—¶é—´ï¼‰ï¼Œæ­¤æ—¶clientè¿›å…¥ä¹‹pendingçŠ¶æ€ï¼Œserverå°†æ•°æ®å‡†å¤‡å¥½æˆ–è¶…æ—¶åè¿”å›ç»™clientã€‚</p>
<p>æ•´ä¸ªæµç¨‹å¦‚å›¾æ‰€ç¤º:<br><img src="https://img-blog.csdnimg.cn/20210123064940962.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dpY2tlZFdpbmdz,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>ç½‘å…³é…ç½®ï¼ˆè®°å¾—é‡å¯ï¼‰</p>
<p>é¦–å…ˆåœ¨ pom.xml æ–‡ä»¶ä¸­ å¼•å…¥ä»¥ä¸‹ä¾èµ–ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!--soul data sync start use http--&gt;</span><br><span class="line">  &lt;dependency&gt;</span><br><span class="line">       &lt;groupId&gt;org.dromara&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;soul-spring-boot-starter-sync-data-http&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;last.version&#125;&lt;&#x2F;version&gt;</span><br><span class="line">  &lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>
<p>åœ¨ springbootçš„ yml æ–‡ä»¶ä¸­è¿›è¡Œå¦‚ä¸‹é…ç½®:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">soul :</span><br><span class="line">   sync:</span><br><span class="line">       http:</span><br><span class="line">            url: http:&#x2F;&#x2F;localhost:9095</span><br></pre></td></tr></table></figure>
<h2 id="æ·±å…¥æºç "><a href="#æ·±å…¥æºç " class="headerlink" title="æ·±å…¥æºç "></a>æ·±å…¥æºç </h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ ¹æ®é…ç½®é¡¹åŠ è½½HttpLongPollingDataChangedListenerè¿™ä¸ªbean</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty</span>(name = <span class="string">"soul.sync.http.enabled"</span>, havingValue = <span class="string">"true"</span>)</span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span>(HttpSyncProperties<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">static</span> <span class="title">class</span> <span class="title">HttpLongPollingListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span>(HttpLongPollingDataChangedListener<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">HttpLongPollingDataChangedListener</span> <span class="title">httpLongPollingDataChangedListener</span>(<span class="title">final</span> <span class="title">HttpSyncProperties</span> <span class="title">httpSyncProperties</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HttpLongPollingDataChangedListener(httpSyncProperties);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * ä½¿ç”¨ ArrayBlockingQueue å­˜æ”¾å®¢æˆ·ç«¯ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªå•çº¿ç¨‹çš„ ScheduledThreadPoolExecutor æ¥å®ç°å‘¨æœŸæ€§ä»»åŠ¡çš„è°ƒåº¦</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> httpSyncProperties the HttpSyncProperties</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">HttpLongPollingDataChangedListener</span><span class="params">(<span class="keyword">final</span> HttpSyncProperties httpSyncProperties)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">this</span>.clients = <span class="keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="number">1024</span>);</span><br><span class="line">     <span class="keyword">this</span>.scheduler = <span class="keyword">new</span> ScheduledThreadPoolExecutor(<span class="number">1</span>,</span><br><span class="line">             SoulThreadFactory.create(<span class="string">"long-polling"</span>, <span class="keyword">true</span>));</span><br><span class="line">     <span class="keyword">this</span>.httpSyncProperties = httpSyncProperties;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>HttpLongPollingDataChangedListener ä¸­æ¯”è¾ƒç²¾é«“çš„å‡½æ•°æ˜¯ checkCacheDelayAndUpdate:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * æ£€æŸ¥å®¢æˆ·ç«¯æ˜¯å¦éœ€è¦æ›´æ–°ç¼“å­˜</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> serverCache the admin local cache</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> clientMd5 the client md5 value</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> clientModifyTime the client last modify time</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> true: the client needs to be updated, false: not need.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">checkCacheDelayAndUpdate</span><span class="params">(<span class="keyword">final</span> ConfigDataCache serverCache, <span class="keyword">final</span> String clientMd5, <span class="keyword">final</span> <span class="keyword">long</span> clientModifyTime)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// å¦‚æœMD5 å€¼ç›¸ç­‰,åˆ™ä¸ç”¨æ›´æ–°</span></span><br><span class="line">       <span class="keyword">if</span> (StringUtils.equals(clientMd5, serverCache.getMd5())) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// å¦‚æœMD5 å€¼ä¸ç›¸ç­‰,åˆ™æ¯”è¾ƒ lastModifyTime</span></span><br><span class="line">       <span class="keyword">long</span> lastModifyTime = serverCache.getLastModifyTime();</span><br><span class="line">       <span class="keyword">if</span> (lastModifyTime &gt;= clientModifyTime) &#123;</span><br><span class="line">           <span class="comment">// the client's config is out of date.</span></span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// the lastModifyTime before client, then the local cache needs to be updated.</span></span><br><span class="line">       <span class="comment">// Considering the concurrency problem, admin must lock,</span></span><br><span class="line">       <span class="comment">// otherwise it may cause the request from soul-web to update the cache concurrently, causing excessive db pressure</span></span><br><span class="line">       <span class="keyword">boolean</span> locked = <span class="keyword">false</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">       	<span class="comment">//å°è¯•å»è·å–é”, è¶…è¿‡5ç§’åæ”¾å¼ƒ</span></span><br><span class="line">           locked = LOCK.tryLock(<span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">           Thread.currentThread().interrupt();</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (locked) &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               ConfigDataCache latest = CACHE.get(serverCache.getGroup());</span><br><span class="line">               <span class="keyword">if</span> (latest != serverCache) &#123;</span><br><span class="line">                   <span class="comment">// the cache of admin was updated. if the md5 value is the same, there's no need to update.</span></span><br><span class="line">                   <span class="comment">// å¦‚æœ admin çš„ç¼“å­˜æ›´æ–°äº† ä½† MD5 ç›¸ç­‰, åˆ™ä¸éœ€è¦æ›´æ–°</span></span><br><span class="line">                   <span class="keyword">return</span> !StringUtils.equals(clientMd5, latest.getMd5());</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="comment">// ä»æ•°æ®åº“ä¸­è¯»å–æ•°æ®å¹¶åŠ å…¥ç¼“å­˜</span></span><br><span class="line">               <span class="keyword">this</span>.refreshLocalCache();</span><br><span class="line">               latest = CACHE.get(serverCache.getGroup());</span><br><span class="line">               <span class="keyword">return</span> !StringUtils.equals(clientMd5, latest.getMd5());</span><br><span class="line">           &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">               LOCK.unlock();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// not locked, the client need to be updated.</span></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å…¶å® checkCacheDelayAndUpdate è·Ÿæœ€è¿‘åšçš„ å®‰å“æ›´æ–°æ£€æµ‹æ¥å£å¾ˆåƒ, å·§å¦™åœ°é€šè¿‡ æ—¶é—´ å’Œ æ•°æ®MD5 è¿™ä¸¤ä¸ªå› å­å¯¹ç¼“å­˜åšæ¯”è¾ƒ, åŒæ—¶è€ƒè™‘åˆ°äº†å¹¶å‘åœºæ™¯, æ·»åŠ äº†ä¸€ä¸ªé”ä¿è¯æ›´æ–°çš„åŸå­æ€§.</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Soul</tag>
      </tags>
  </entry>
  <entry>
    <title>Soul ç½‘å…³æºç åˆ†æï¼ˆä¹ï¼‰ä½¿ç”¨ Nacos åŒæ­¥æ•°æ®åˆ°ç½‘å…³</title>
    <url>/2021/01/24/Soul-%E7%BD%91%E5%85%B3%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88%E4%B9%9D%EF%BC%89%E4%BD%BF%E7%94%A8-Nacos-%E5%90%8C%E6%AD%A5%E6%95%B0%E6%8D%AE%E5%88%B0%E7%BD%91%E5%85%B3/</url>
    <content><![CDATA[<p>Nacos æ˜¯ä¸€æ¬¾å‘ç°ã€é…ç½®å’Œå¾®æœåŠ¡ç®¡ç†å·¥å…·ã€‚å®ƒæä¾›äº†ä¸€ç»„ç®€å•æ˜“ç”¨çš„ç‰¹æ€§é›†ï¼Œå¯ä»¥å¿«é€Ÿå®ç°åŠ¨æ€æœåŠ¡å‘ç°ã€æœåŠ¡é…ç½®ã€æœåŠ¡å…ƒæ•°æ®åŠæµé‡ç®¡ç†ã€‚</p>
<a id="more"></a>
<p>å®‰è£…å¯åŠ¨å¥½ Nacos åï¼Œä¿®æ”¹å¯¹åº”çš„ soul-admin å’Œ soul-bootstrap ä¸­çš„é…ç½®ï¼š</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">soul:</span></span><br><span class="line">    <span class="attr">file:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">corss:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">dubbo :</span></span><br><span class="line">      <span class="attr">parameter:</span> <span class="string">multi</span></span><br><span class="line">    <span class="attr">sync:</span></span><br><span class="line"><span class="comment">#        websocket :</span></span><br><span class="line"><span class="comment">#             urls: ws://localhost:9095/websocket</span></span><br><span class="line">      <span class="attr">nacos:</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">localhost:8848</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">1c10d748-af86-43b9-8265-75f487d20c6c</span></span><br></pre></td></tr></table></figure>
<p>åœ¨ soul-bootstrap çš„ pom.xml ä¸­åŠ å…¥ä¾èµ–ï¼š</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.dromara<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>soul-spring-boot-starter-sync-data-nacos<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>å¯åŠ¨ soul-admin å’Œ soul-bootstrapï¼Œå‘ç° soul-bootstrap æ— æ³•å¯åŠ¨ï¼ŒåŸå› æ˜¯åœ¨ NacosCacheHandler ç±»ä¸­ï¼Œä»¥ä¸‹ä»£ç å¤„ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">updateMetaDataMap</span><span class="params">(<span class="keyword">final</span> String configInfo)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    	<span class="comment">//è¿™é‡Œä¼šæŠ›å‡º NullPointerException ï¼Œå› ä¸ºæš‚æ—¶æ²¡æœ‰å®ç° Nacos çš„æ•°æ®åˆå§‹åŒ–ã€‚</span></span><br><span class="line">        List&lt;MetaData&gt; metaDataList = <span class="keyword">new</span> ArrayList&lt;&gt;(GsonUtils.getInstance().toObjectMap(configInfo, MetaData<span class="class">.<span class="keyword">class</span>).<span class="title">values</span>())</span>;</span><br><span class="line">        metaDataList.forEach(metaData -&gt; metaDataSubscribers.forEach(subscriber -&gt; &#123;</span><br><span class="line">            subscriber.unSubscribe(metaData);</span><br><span class="line">            subscriber.onSubscribe(metaData);</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (JsonParseException e) &#123;</span><br><span class="line">        log.error(<span class="string">"sync meta data have error:"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åªèƒ½åœ¨ Nacos åå°æ‰‹åŠ¨æ·»åŠ åˆå§‹åŒ–æ•°æ®ï¼Œéœ€è¦åˆ†åˆ«æ·»åŠ  å…ƒæ•°æ® å’Œ è®¤è¯çš„æ•°æ®ã€‚è¯¦ç»†çš„è§£å†³åŠæ³•å¯ä»¥å‚è€ƒ <a href="https://www.jianshu.com/p/8294289145a7" target="_blank" rel="noopener">soul ç½‘å…³å…¥é—¨ç¯‡ï¼ˆä¸ƒï¼‰ï¼šæ•°æ®åŒæ­¥æ–¹å¼- nacos é…ç½®</a></p>
<p><code>2021-01-24 02:15:31.175  INFO 90111 --- [           main] d.s.s.s.s.d.n.NacosSyncDataConfiguration : you use nacos sync soul data......</code><br>çœ‹åˆ°è¿™ä¸ªä»£è¡¨å·²ç»æˆåŠŸä½¿ç”¨ Nacos åŒæ­¥æ•°æ®äº†ã€‚</p>
<p>çœ‹ä¸€ä¸‹ Nacos çš„ç®¡ç†ç«¯æƒ…å†µï¼Œå‘ç°å¹¶æ²¡æœ‰æ•°æ®ï¼Œä½†æ˜¯åœ¨ NacosDataChangedListener æ‰“æ–­ç‚¹åç‚¹å‡»åŒæ­¥æ•°æ®çš„è¯ï¼Œæ˜¯èƒ½è¿›åˆ° å¯¹åº”çš„å‡½æ•°çš„ï¼š<br><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4914a9d648a44b5bb6437f6ab62935b7~tplv-k3u1fbpfcp-watermark.image" alt=""><br>ç”±äºç¼ºä¹å¯¹ Nacos çš„è®¤çŸ¥ï¼Œæˆ‘å†³å®šæš‚æ—¶è’™åœ¨é¼“é‡Œã€‚</p>
<p>Nacos åŒæ­¥é…ç½®ä¿¡æ¯çš„é€»è¾‘éå¸¸ç®€å•ï¼Œå°±æ˜¯è¿ç”¨äº† Nacos ä¸­çš„ ConfigServiceï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ä»Nacosé…ç½®æœåŠ¡è·å–é…ç½®</span></span><br><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getConfig</span><span class="params">(<span class="keyword">final</span> String dataId)</span> </span>&#123;</span><br><span class="line">    String config = configService.getConfig(dataId, GROUP, <span class="number">6000</span>);</span><br><span class="line">    <span class="keyword">return</span> StringUtils.hasLength(config) ? config : EMPTY_CONFIG_DEFAULT_VALUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å‘å¸ƒæ•°æ®åˆ°Nacosé…ç½®æœåŠ¡</span></span><br><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">publishConfig</span><span class="params">(<span class="keyword">final</span> String dataId, <span class="keyword">final</span> Object data)</span> </span>&#123;</span><br><span class="line">    configService.publishConfig(dataId, GROUP, GsonUtils.getInstance().toJson(data));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ Nacos ç®¡ç†ç«¯æ·»åŠ å¯¹åº”çš„ namespaceï¼Œå¯¹åº”soul-admin å’Œ soul-bootstrap é…ç½®ä¸­çš„ namespace:<br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/892574b601064cb6a4191da38bb5c578~tplv-k3u1fbpfcp-watermark.image" alt=""></p>
<p>å†æ¬¡æŸ¥çœ‹é…ç½®ç®¡ç†ï¼Œå‘ç°å·²ç»æœ‰äº†å¯¹åº”çš„é…ç½®æ•°æ®jsonäº†ã€‚<br><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dd1430118c83448b9f766adbd6f3fd83~tplv-k3u1fbpfcp-watermark.image" alt=""></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>Nacos æœ‰ä¸ªç‹¬ç«‹çš„é…ç½®ç®¡ç†æœåŠ¡ ConfigServiceï¼Œå¦‚æœè¦äº†è§£ä¸ºä»€ä¹ˆåœ¨ Nacos åå°ä¸­çœ‹ä¸åˆ°ä»»ä½•æ•°æ®å’ŒèŠ‚ç‚¹ï¼Œè¿˜éœ€è¦æ·±å…¥äº†è§£ Nacos é…ç½®æœåŠ¡çš„å®ç°åŸç†æ‰è¡Œã€‚ç”¨ Nacos åšæ•°æ®åŒæ­¥è·ŸZookeeper æ˜¯åŒæ ·çš„é—®é¢˜ï¼Œéœ€è¦ç»´æŠ¤é¢å¤–çš„ä¸­é—´ä»¶é€ æˆç»´æŠ¤æˆæœ¬çš„æå‡ã€‚</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Soul</tag>
      </tags>
  </entry>
  <entry>
    <title>Soul ç½‘å…³æºç åˆ†æï¼ˆåï¼‰ä½¿ç”¨é›†ç¾¤æ¨¡å¼éƒ¨ç½²soul-bootstrap</title>
    <url>/2021/01/26/Soul-%E7%BD%91%E5%85%B3%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88%E5%8D%81%EF%BC%89%E4%BD%BF%E7%94%A8%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F%E9%83%A8%E7%BD%B2soul-bootstrap/</url>
    <content><![CDATA[<p>åˆ†æäº†å¤šç§æ•°æ®åŒæ­¥æ–¹å¼åï¼Œæˆ‘ä»¬æ¥è¯•è¯• Soul ç½‘å…³çš„<strong>é›†ç¾¤æ¨¡å¼</strong>ã€‚</p>
<a id="more"></a>

<p>é¦–å…ˆæˆ‘ä»¬ä½¿ç”¨ mvn clean intall &amp;&amp; mvn clean package æ¥æ‰“å‡ºjaråŒ…ï¼Œè¿›å…¥ soul-bootstrap/targetï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ‰å¯åŠ¨å¤šä¸ª soul-bootstrap æœåŠ¡ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java -jar soul-bootstrap.jar --server.port&#x3D;8095</span><br><span class="line">java -jar soul-bootstrap.jar --server.port&#x3D;8096</span><br><span class="line">java -jar soul-bootstrap.jar --server.port&#x3D;8097</span><br></pre></td></tr></table></figure>
<p>å¯åŠ¨ä¸‰ä¸ªæœåŠ¡åï¼Œæˆ‘ä»¬éœ€è¦ç”¨ nginx åšä¸‹è´Ÿè½½å‡è¡¡ã€‚</p>
<p>ä½¿ç”¨ vim ç¼–å†™é…ç½®æ–‡ä»¶ï¼ˆå…¶ä¸­ soul.hazyrain.com å¯ä»¥æ¢æˆä½ å–œæ¬¢çš„åŸŸåï¼Œåœ¨ <strong>hosts</strong> æ–‡ä»¶ä¸Šåšå¥½é…ç½®å³å¯ï¼‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#é…ç½®upstreamï¼Œæ³¨æ„è¿™ä¸ªåé¢çš„ bootstrap æ˜¯ aliasï¼ŒæŠŠä»–é…ç½®åˆ°location é‚£é‡Œ</span><br><span class="line">upstream bootstrap &#123;</span><br><span class="line">    server localhost:8095 fail_timeout&#x3D;3s max_fails&#x3D;2;</span><br><span class="line">    server localhost:8096 fail_timeout&#x3D;3s max_fails&#x3D;2;</span><br><span class="line">    server localhost:8097 fail_timeout&#x3D;3s max_fails&#x3D;2;</span><br><span class="line">    #æ·»åŠ  ip hashï¼Œèƒ½å°†æ¥è‡ªåŒä¸€ IP çš„å®¢æˆ·ç«¯è¯·æ±‚æ´¾å‘ç»™åŒä¸€ä¸ªæœåŠ¡å®ä¾‹</span><br><span class="line">    ip_hash;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen   80;</span><br><span class="line">    server_name  soul.hazyrain.com;</span><br><span class="line"></span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        proxy_pass   http:&#x2F;&#x2F;bootstrap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œ <code>nginx -s reload</code> ï¼Œæ›´æ–°é…ç½®ã€‚</p>
<p>å°è¯•è®¿é—® soul.hazyrain.comï¼š<br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/71d6bc1b86984deab7f50c0058435738~tplv-k3u1fbpfcp-watermark.image" alt=""><br>OKï¼Œæˆ‘ä»¬å·²ç»æˆåŠŸä½¿ç”¨nginx ä»£ç†äº† ä¸‰ä¸ªèŠ‚ç‚¹çš„ soul-bootstrap é›†ç¾¤ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬æ¥å¯åŠ¨ä¸€ä¸ªç®€å•çš„ flask åº”ç”¨ï¼Œå¹¶åœ¨soul-admin ä¸­é…ç½®å¯¹åº”è§„åˆ™ï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5b61479b498b42f4bcc817bdda95bf97~tplv-k3u1fbpfcp-watermark.image" alt=""></p>
<p>è°ƒç”¨ soul-admin æ³¨å†Œ http æœåŠ¡çš„æ¥å£æ³¨å†ŒæœåŠ¡ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">#POSTè¯·æ±‚ï¼š'http://localhost:9095/soul-client/springmvc-register'</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"appName"</span>: <span class="string">"fake-api"</span>,</span><br><span class="line">    <span class="string">"context"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"path"</span>: <span class="string">"fake"</span>,</span><br><span class="line">    <span class="string">"rpcType"</span>: <span class="string">"http"</span>,</span><br><span class="line">    <span class="string">"host"</span>: <span class="string">"soul.hazyrain.com"</span>,</span><br><span class="line">    <span class="string">"port"</span>: <span class="number">5000</span>,</span><br><span class="line">    <span class="string">"ruleName"</span>: <span class="string">"fake"</span>,</span><br><span class="line">    <span class="string">"enabled"</span>: <span class="string">"true"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å†è°ƒç”¨ æˆ‘ä»¬çš„nginx ä»£ç†é›†ç¾¤çš„ endpointï¼š<code>http://soul.hazyrain.com/fake/foo/bar</code><br>æˆåŠŸè¿”å›æ•°æ®ï¼š<br><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/474e7e9d71504598aef1de76140a4842~tplv-k3u1fbpfcp-watermark.image" alt=""></p>
<p>ä½¿ç”¨ postman çš„ runner åšä¸‹æµ‹è¯•ï¼Œæ‰§è¡Œ500æ¬¡è°ƒç”¨ï¼ŒæŸ¥çœ‹è°ƒç”¨ç»“æœï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"id"</span>: <span class="string">"789bccc1-f41c-45ee-8033-aff647a1fab0"</span>,</span><br><span class="line">	<span class="attr">"name"</span>: <span class="string">"soul"</span>,</span><br><span class="line">	<span class="attr">"timestamp"</span>: <span class="string">"2021-01-25T15:04:31.400Z"</span>,</span><br><span class="line">	<span class="attr">"collection_id"</span>: <span class="string">"be2b94d5-ff96-484f-b7e0-23bda6d4d908"</span>,</span><br><span class="line">	<span class="attr">"folder_id"</span>: <span class="number">0</span>,</span><br><span class="line">	<span class="attr">"environment_id"</span>: <span class="string">"0"</span>,</span><br><span class="line">	<span class="attr">"totalPass"</span>: <span class="number">1000</span>,</span><br><span class="line">	<span class="attr">"totalFail"</span>: <span class="number">0</span>,</span><br><span class="line">	<span class="attr">"results"</span>: [</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="attr">"id"</span>: <span class="string">"266f5d02-bfbe-4a93-8679-7267c8d75cd8"</span>,</span><br><span class="line">			<span class="attr">"name"</span>: <span class="string">"proxy test"</span>,</span><br><span class="line">			<span class="attr">"time"</span>: <span class="number">2</span>,</span><br><span class="line">			<span class="attr">"responseCode"</span>: &#123;</span><br><span class="line">				<span class="attr">"code"</span>: <span class="number">200</span>,</span><br><span class="line">				<span class="attr">"name"</span>: <span class="string">"OK"</span></span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="attr">"tests"</span>: &#123;</span><br><span class="line">				<span class="attr">"Status code is 200"</span>: <span class="literal">true</span>,</span><br><span class="line">				<span class="attr">"Body matches string"</span>: <span class="literal">true</span></span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="attr">"testPassFailCounts"</span>: &#123;</span><br><span class="line">				<span class="attr">"Status code is 200"</span>: &#123;</span><br><span class="line">					<span class="attr">"pass"</span>: <span class="number">500</span>,</span><br><span class="line">					<span class="attr">"fail"</span>: <span class="number">0</span></span><br><span class="line">				&#125;,</span><br><span class="line">				<span class="attr">"Body matches string"</span>: &#123;</span><br><span class="line">					<span class="attr">"pass"</span>: <span class="number">500</span>,</span><br><span class="line">					<span class="attr">"fail"</span>: <span class="number">0</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="attr">"times"</span>: [],<span class="comment">//ç•¥</span></span><br><span class="line">			<span class="attr">"allTests"</span>: [] <span class="comment">//ç•¥</span></span><br><span class="line">		&#125;</span><br><span class="line">	],</span><br><span class="line">	<span class="attr">"count"</span>: <span class="number">500</span>,</span><br><span class="line">	<span class="attr">"totalTime"</span>: <span class="number">1675</span>,</span><br><span class="line">	<span class="attr">"collection"</span>: &#123;</span><br><span class="line">		<span class="attr">"requests"</span>: [</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="attr">"id"</span>: <span class="string">"266f5d02-bfbe-4a93-8679-7267c8d75cd8"</span>,</span><br><span class="line">				<span class="attr">"method"</span>: <span class="string">"GET"</span></span><br><span class="line">			&#125;</span><br><span class="line">		]</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”± count å’Œ totalTime å¯ä»¥è®¡ç®—å‡ºï¼Œå¹³å‡è€—æ—¶ä¸º 3.35 æ¯«ç§’ï¼Œç›¸å½“å¯è§‚çš„æ•°å­—ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>Soul ç½‘å…³èƒ½å¤Ÿæ”¯æ’‘å¤šä¸ªç½‘å…³èŠ‚ç‚¹åšè´Ÿè½½å‡è¡¡ï¼Œé…ç½®ä¹Ÿå¯é€šè¿‡soul-admin åŒæ­¥åˆ°æ‰€æœ‰èŠ‚ç‚¹ä¸Šã€‚åŒæ—¶ websocket æ–­å¼€é“¾æ¥åï¼Œsoul-bootstrap ä¹Ÿæœ‰é‡è¿çš„æœºåˆ¶ï¼Œç›¸å½“å¯é ã€‚</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Soul</tag>
      </tags>
  </entry>
  <entry>
    <title>Soul ç½‘å…³æºç åˆ†æï¼ˆåä¸€ï¼‰ratelimiter æ’ä»¶ï¼ˆä¸€ï¼‰</title>
    <url>/2021/01/27/Soul-%E7%BD%91%E5%85%B3%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89ratelimiter-%E6%8F%92%E4%BB%B6%EF%BC%88%E4%B8%80%EF%BC%89/</url>
    <content><![CDATA[<p>Soul ç½‘å…³æä¾›äº†é™æµæ’ä»¶ï¼Œæ–¹ä¾¿ç”¨æˆ·æ§åˆ¶æŒ‡å®šæ—¶é—´æ®µå†…ç»è¿‡ç½‘å…³çš„è¯·æ±‚æ•°é‡ã€‚</p>
<a id="more"></a>
<h2 id="ä»€ä¹ˆæ˜¯â€œé™æµâ€ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯â€œé™æµâ€ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯â€œé™æµâ€ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯â€œé™æµâ€ï¼Ÿ</h2><p>ç«é”…åº—ä¸€èˆ¬éƒ½æœ‰æœ€å¤§çš„å®¹å®¢é‡ï¼Œå¤§æ¡Œå°æ¡Œçš„å¸­ä½æ•°æ˜¯å›ºå®šçš„ã€‚åœ¨å°±é¤é«˜å³°æœŸæ—¶ï¼Œå¤§é‡çš„é£Ÿå®¢ä¼šèœ‚æ‹¥è€Œè‡³ï¼Œä¸€èˆ¬ç«é”…åº—çš„å‘˜å·¥æ˜¯æ ¹æ®åº§ä½æ•°åˆ†é…çš„ï¼Œå¦‚æœä¸é™åˆ¶è¿›å…¥ç«é”…åº—çš„äººæµï¼Œå‘˜å·¥ä¼šå¿™ä¸è¿‡æ¥ï¼Œé£Ÿå®¢çš„ä½“éªŒä¹Ÿä¼šå˜å·®ã€‚åœ¨è¿™é‡Œé™åˆ¶åº§ä½æ•°å°±æ˜¯ä¸€ç§é™æµçš„æ‰‹æ®µã€‚è€Œå–åˆ°å·ç‰Œå¹¶è¢«å«åˆ°å·çš„é¡¾å®¢æ‰èƒ½å…¥åº§å°±é¤ï¼Œè¿™è·Ÿä»¤ç‰Œæ¡¶</p>
<p>åç«¯æ¶æ„ä¸­çš„é™æµä¸€èˆ¬åˆ†ä¸ºä¸¤ç§ï¼Œå¯¹å¤–ä¸»è¦é’ˆå¯¹ DDOSæ”»å‡»ä»¥åŠçˆ¬è™«é˜²èŒƒï¼Œå¯¹å†…ä¸»è¦æ§åˆ¶çƒ­ç‚¹å…¬å…±æœåŠ¡è°ƒç”¨çš„å‡åŒ€åˆ†é…ã€‚</p>
<h2 id="Soul-æ˜¯å¦‚ä½•åšé™æµçš„ï¼Ÿ"><a href="#Soul-æ˜¯å¦‚ä½•åšé™æµçš„ï¼Ÿ" class="headerlink" title="Soul æ˜¯å¦‚ä½•åšé™æµçš„ï¼Ÿ"></a>Soul æ˜¯å¦‚ä½•åšé™æµçš„ï¼Ÿ</h2><p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹çœ‹ soul-plugin-ratelimiter çš„æ–‡ä»¶ç›®å½•ç»“æ„ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">â””â”€â”€ src</span><br><span class="line">    â”œâ”€â”€ main</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ java</span><br><span class="line">    â”‚Â Â  â”‚Â Â  â””â”€â”€ org</span><br><span class="line">    â”‚Â Â  â”‚Â Â      â””â”€â”€ dromara</span><br><span class="line">    â”‚Â Â  â”‚Â Â          â””â”€â”€ soul</span><br><span class="line">    â”‚Â Â  â”‚Â Â              â””â”€â”€ plugin</span><br><span class="line">    â”‚Â Â  â”‚Â Â                  â””â”€â”€ ratelimiter</span><br><span class="line">    â”‚Â Â  â”‚Â Â                      â”œâ”€â”€ RateLimiterPlugin.java AbstractSoulPlugin å®ç°ç±»ï¼Œæ ¸å¿ƒå‡½æ•°æ˜¯ doExecuteï¼Œ</span><br><span class="line">    â”‚Â Â  â”‚Â Â                      â”œâ”€â”€ config</span><br><span class="line">    â”‚Â Â  â”‚Â Â                      â”‚Â Â  â””â”€â”€ RateLimiterConfig.java ratelimiter ç›¸å…³é…ç½®é¡¹</span><br><span class="line">    â”‚Â Â  â”‚Â Â                      â”œâ”€â”€ executor</span><br><span class="line">    â”‚Â Â  â”‚Â Â                      â”‚Â Â  â””â”€â”€ RedisRateLimiter.java åŸºäº redis çš„ä»¤ç‰Œæ¡¶ç®—æ³•å®ç°ï¼Œæ ¸å¿ƒå‡½æ•°æ˜¯ isAllowed</span><br><span class="line">    â”‚Â Â  â”‚Â Â                      â”œâ”€â”€ handler</span><br><span class="line">    â”‚Â Â  â”‚Â Â                      â”‚Â Â  â””â”€â”€ RateLimiterPluginDataHandler.java ä»æ’ä»¶é…ç½®è¯»å–æ•°æ®çš„handler</span><br><span class="line">    â”‚Â Â  â”‚Â Â                      â””â”€â”€ response</span><br><span class="line">    â”‚Â Â  â”‚Â Â                          â””â”€â”€ RateLimiterResponse.java ratelimiter response ç±»</span><br><span class="line">    â”‚Â Â  â””â”€â”€ resources</span><br><span class="line">    â”‚Â Â      â””â”€â”€ META-INF</span><br><span class="line">    â”‚Â Â          â””â”€â”€ scripts</span><br><span class="line">    â”‚Â Â              â”œâ”€â”€ concurrent_request_rate_limiter.lua å¹¶å‘ ratelimiter luaè„šæœ¬</span><br><span class="line">    â”‚Â Â              â””â”€â”€ request_rate_limiter.lua ratelimiter luaè„šæœ¬</span><br><span class="line">    â””â”€â”€ test</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦å¯åŠ¨ redis-server</p>
<p>ç„¶ååœ¨ admin ä¸­é…ç½® ratelimiter æ’ä»¶ï¼Œé¦–å…ˆåœ¨æ’ä»¶ç®¡ç†ä¸­å¼€å¯ ratelimiterï¼Œå†é…ç½® ratelimiter çš„ selecter å’Œ ruleï¼š<br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d322f3fc554e498f87aa3851e65c0824~tplv-k3u1fbpfcp-watermark.image" alt=""></p>
<p>é…ç½®å®Œæˆåä½¿ç”¨postmanæ¨¡æ‹Ÿä¸é—´æ–­çš„ 200 æ¬¡è¯·æ±‚ï¼š<br><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b717650ad5e14096bd37db58b77b9356~tplv-k3u1fbpfcp-watermark.image" alt=""><br>åœ¨æ‰§è¡Œå®Œ 10 æ¬¡åçš„ ç¬¬11æ¬¡ï¼Œratelimiter é˜»æ–­äº†æˆ‘ä»¬çš„è¯·æ±‚ï¼Œå› ä¸ºä»¤ç‰Œæ¡¶ä¸­çš„ä»¤ç‰Œå·²ç»è¢«æ¶ˆè€—å…‰äº†ï¼ˆcapacity ä¸º 10ï¼‰ï¼Œè€Œå¡«å……é€Ÿç‡ï¼ˆrateï¼‰ä¸º 5ï¼Œæ„å‘³ç€ç”¨æˆ·æ¯ç§’æœ€å¤šè¯·æ±‚ 5æ¬¡ åå°±è¢«é™æµã€‚</p>
<p>ä¸‹å›¾æ˜¯ä»¤ç‰Œæ¡¶ç®—æ³•çš„åˆ†é…æµç¨‹ï¼Œå…¶å®è·Ÿç«é”…åº—åˆ†é…æ’é˜Ÿå·ç‰Œæ˜¯å·®ä¸å¤šçš„åŸç†ï¼š</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/08542f0b3bce4f32b2608d2a7f021d3b~tplv-k3u1fbpfcp-watermark.image" alt=""></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ratelimiter å¯ä»¥å¸®åŠ©æˆ‘ä»¬åœ¨ç½‘å…³å±‚è¿‡æ»¤æ‰ä¸éœ€è¦æˆ–è€…å¼‚å¸¸çš„è¯·æ±‚è€Œé¿å…æ¶ˆè€—åç«¯æœåŠ¡çš„èµ„æºï¼Œè¿™ä¹Ÿæ˜¯æˆ‘è®¤ä¸ºç½‘å…³åœ¨è½¯ä»¶æ¶æ„ä¸­çš„é‡è¦èŒèƒ½ä¹‹ä¸€ï¼ŒSoul ä½¿ç”¨ redis åšä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œæ˜å¤©çš„è®¡åˆ’æ˜¯æ·±å…¥å‰–æ é€šè¿‡ lua è„šæœ¬å®ç°ä»¤ç‰Œæ¡¶ç®—æ³•çš„åŸç†ã€‚</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>interview</tag>
      </tags>
  </entry>
  <entry>
    <title>Soul ç½‘å…³æºç åˆ†æï¼ˆåäºŒï¼‰ratelimiter æ’ä»¶ï¼ˆäºŒï¼‰</title>
    <url>/2021/01/27/Soul-%E7%BD%91%E5%85%B3%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88%E5%8D%81%E4%BA%8C%EF%BC%89ratelimiter-%E6%8F%92%E4%BB%B6%EF%BC%88%E4%BA%8C%EF%BC%89/</url>
    <content><![CDATA[<p>åœ¨ä¸Šä¸€ç¯‡æˆ‘ä»¬ç†Ÿæ‚‰äº†é™æµå·²ç» ratelimiter æ’ä»¶çš„å®ç°åŸç†ï¼Œä»Šå¤©æˆ‘ä»¬ä»æºç å…¥æ‰‹è¯¦ç»†åœ°ç†ä¸€ä¸‹æ•´ä¸ªæµç¨‹ã€‚</p>
<a id="more"></a>
<h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><p>RedisRateLimiterç±»ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">RedisRateLimiter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//è¿™é‡Œä¼šè°ƒç”¨ redisScriptå‡½æ•°ï¼Œè¯»å–å¹¶è®¾ç½® this.script</span></span><br><span class="line">    <span class="keyword">this</span>.script = redisScript();</span><br><span class="line">    initialized.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id            è§„åˆ™ID</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> replenishRate åˆ·æ–°ç‡ï¼Œå°±æ˜¯æ¯æ¬¡å¡«å……è¿›æ¥çš„ä»¤ç‰Œæ•°</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> burstCapacity ä»¤ç‰Œæ¡¶çš„æœ€å¤§å®¹é‡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> Mono&lt;Response&gt;&#125; to indicate when request processing is complete</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Mono&lt;RateLimiterResponse&gt; <span class="title">isAllowed</span><span class="params">(<span class="keyword">final</span> String id, <span class="keyword">final</span> <span class="keyword">double</span> replenishRate, <span class="keyword">final</span> <span class="keyword">double</span> burstCapacity)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//å¦‚æœæ²¡æœ‰åˆå§‹åŒ–å®Œæˆï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.initialized.get()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"RedisRateLimiter is not initialized"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;String&gt; keys = getKeys(id);</span><br><span class="line">    <span class="comment">//æ„é€  redis è„šæœ¬å‚æ•°ï¼Œç­‰ä¼šæˆ‘ä»¬å»luaè„šæœ¬çœ‹çœ‹</span></span><br><span class="line">    List&lt;String&gt; scriptArgs = Arrays.asList(replenishRate + <span class="string">""</span>, burstCapacity + <span class="string">""</span>, Instant.now().getEpochSecond() + <span class="string">""</span>, <span class="string">"1"</span>);</span><br><span class="line">    <span class="comment">//é€šè¿‡ ReactiveRedisTemplate æ¥æ‰§è¡Œåœ¨æ„é€ å‡½æ•°ä¸­åŠ è½½çš„è„šæœ¬</span></span><br><span class="line">    Flux&lt;List&lt;Long&gt;&gt; resultFlux = Singleton.INST.get(ReactiveRedisTemplate<span class="class">.<span class="keyword">class</span>).<span class="title">execute</span>(<span class="title">this</span>.<span class="title">script</span>, <span class="title">keys</span>, <span class="title">scriptArgs</span>)</span>;</span><br><span class="line">    <span class="comment">//å½“æœ‰å¼‚å¸¸å‘ç”Ÿæ—¶æ¥æ”¶å¼‚å¸¸ä¿¡æ¯ï¼Œè¾“å‡ºå’Œæµä¸­æ•°æ®çš„ç±»å‹ç›¸åŒçš„å€¼ï¼Œä½¿ç”¨è¿™ä¸ªè¿”å›å€¼æ›¿ä»£å¼‚å¸¸çš„æ•°æ®å€¼è¿”å›ç»™Subscriber</span></span><br><span class="line">    <span class="keyword">return</span> resultFlux.onErrorResume(throwable -&gt; Flux.just(Arrays.asList(<span class="number">1L</span>, -<span class="number">1L</span>))) </span><br><span class="line">    		<span class="comment">//å¯¹è¿”å›çš„ List&lt;Long&gt; åš reduce æ“ä½œ</span></span><br><span class="line">            .reduce(<span class="keyword">new</span> ArrayList&lt;Long&gt;(), (longs, l) -&gt; &#123;</span><br><span class="line">                longs.addAll(l);</span><br><span class="line">                <span class="keyword">return</span> longs;</span><br><span class="line">            &#125;).map(results -&gt; &#123; <span class="comment">//é’ˆå¯¹æµä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ï¼Œæ‰§è¡Œå¯¹åº”æ“ä½œ</span></span><br><span class="line">                <span class="keyword">boolean</span> allowed = results.get(<span class="number">0</span>) == <span class="number">1L</span>; <span class="comment">//å¦‚æœ ç¬¬ä¸€ä¸ªç»“æœæ˜¯ 1Lï¼Œåˆ™å…è®¸è¯·æ±‚é€šè¿‡</span></span><br><span class="line">                Long tokensLeft = results.get(<span class="number">1</span>); <span class="comment">//è·å–æ¡¶ä¸­å‰©ä½™çš„ token æ•°é‡</span></span><br><span class="line">                RateLimiterResponse rateLimiterResponse = <span class="keyword">new</span> RateLimiterResponse(allowed, tokensLeft);</span><br><span class="line">                log.info(<span class="string">"RateLimiter response:&#123;&#125;"</span>, rateLimiterResponse.toString());</span><br><span class="line">                <span class="keyword">return</span> rateLimiterResponse;</span><br><span class="line">            &#125;).doOnError(throwable -&gt; log.error(<span class="string">"Error determining if user allowed from redis:&#123;&#125;"</span>, throwable.getMessage()));<span class="comment">//åœ¨å‘ç”Ÿå¼‚å¸¸æ—¶æ‰“å°æ—¥å¿—</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ Lua è„šæœ¬ä¸­çš„å†…å®¹ï¼š</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">--æ¥æ”¶ tokens_key å’Œ timestamp_key</span></span><br><span class="line"><span class="keyword">local</span> tokens_key = KEYS[<span class="number">1</span>] </span><br><span class="line"><span class="keyword">local</span> timestamp_key = KEYS[<span class="number">2</span>]</span><br><span class="line"><span class="comment">--å°† rate, capacity, å½“å‰ç§’çº§æ—¶é—´æˆ³, å’Œ requested å‚æ•°ä¼ å…¥ï¼Œä»Javaä»£ç ä¸­çœ‹åˆ°æ˜¯ "1"</span></span><br><span class="line"><span class="keyword">local</span> rate = <span class="built_in">tonumber</span>(ARGV[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">local</span> capacity = <span class="built_in">tonumber</span>(ARGV[<span class="number">2</span>])</span><br><span class="line"><span class="keyword">local</span> now = <span class="built_in">tonumber</span>(ARGV[<span class="number">3</span>])</span><br><span class="line"><span class="keyword">local</span> requested = <span class="built_in">tonumber</span>(ARGV[<span class="number">4</span>])</span><br><span class="line"><span class="comment">-- å¡«å……æ—¶é—´ï¼Œè®¡ç®—å‡ºå¡«å……éœ€è¦çš„æ—¶é—´ï¼Œåœ¨ä¸Šä¸€èŠ‚ä¸­æˆ‘ä»¬çš„ capacity è®¾ç½®ä¸º10ï¼Œrate ä¸º5 åˆ™å¡«å……æ—¶é—´ä¸º 2</span></span><br><span class="line"><span class="keyword">local</span> fill_time = capacity/rate</span><br><span class="line"><span class="comment">-- å¯¹å¡«å……æ—¶é—´å‘ä¸Šå–æ•´ï¼Œè·å– key çš„è¿‡æœŸæ—¶é—´</span></span><br><span class="line"><span class="keyword">local</span> ttl = <span class="built_in">math</span>.<span class="built_in">floor</span>(fill_time*<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- è·å–å‰©ä½™çš„ token æ•°é‡</span></span><br><span class="line"><span class="keyword">local</span> last_tokens = <span class="built_in">tonumber</span>(redis.call(<span class="string">"get"</span>, tokens_key))</span><br><span class="line"><span class="keyword">if</span> last_tokens == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line"><span class="comment">-- å¦‚æœä¸å­˜åœ¨è¿™ä¸ª key åˆ™åˆå§‹åŒ–ä»¤ç‰Œæ¡¶</span></span><br><span class="line">  last_tokens = capacity</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- è·å–æœ€è¿‘æ›´æ–°çš„æ—¶é—´æˆ³</span></span><br><span class="line"><span class="keyword">local</span> last_refreshed = <span class="built_in">tonumber</span>(redis.call(<span class="string">"get"</span>, timestamp_key))</span><br><span class="line"><span class="keyword">if</span> last_refreshed == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line"><span class="comment">-- å¦‚æœä¸å­˜åœ¨è¿™ä¸ªkeyï¼Œåˆ™è®¾ç½®value ä¸º 0</span></span><br><span class="line">  last_refreshed = <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- è®¡ç®—å½“å‰æ—¶é—´ä¸ä¸Šæ¬¡æ›´æ–°æ—¶é—´çš„ æ—¶é—´å·®ï¼ˆç§’ï¼‰</span></span><br><span class="line"><span class="keyword">local</span> delta = <span class="built_in">math</span>.<span class="built_in">max</span>(<span class="number">0</span>, now-last_refreshed)</span><br><span class="line"><span class="comment">-- è®¡ç®—å·²ç»å¡«å……åˆ°æ¡¶ä¸­çš„ä»¤ç‰Œæ•°ï¼Œå–æ¡¶å®¹é‡ å’Œ å‰©ä½™ä»¤ç‰Œæ•°åŠ ä¸Šæ—¶é—´å·®ä¹˜ä»¥å¡«å……é€Ÿç‡ ä¸­**æœ€å°**çš„é‚£ä¸ªå€¼</span></span><br><span class="line"><span class="keyword">local</span> filled_tokens = <span class="built_in">math</span>.<span class="built_in">min</span>(capacity, last_tokens+(delta*rate))</span><br><span class="line"><span class="comment">-- è®¡ç®—æ˜¯å¦å…è®¸è¯·æ±‚å’Œæ ¸å¿ƒæ­¥éª¤ï¼šåˆ¤æ–­å‰©ä½™ä»¤ç‰Œæ•°æ˜¯å¦å¤§äºç­‰äº1</span></span><br><span class="line"><span class="keyword">local</span> allowed = filled_tokens &gt;= requested</span><br><span class="line"><span class="comment">-- ç”¨ä¸€ä¸ªå˜é‡å­˜å‚¨æ›´æ–°åçš„ tokenæ•°</span></span><br><span class="line"><span class="keyword">local</span> new_tokens = filled_tokens</span><br><span class="line"><span class="keyword">local</span> allowed_num = <span class="number">0</span></span><br><span class="line"><span class="comment">-- å¦‚æœå…è®¸é€šè¿‡ï¼Œåˆ™å°†å‡å» 1 çš„ä»¤ç‰Œæ•°æ›´æ–°åˆ° tokens_key ä¸­</span></span><br><span class="line"><span class="keyword">if</span> allowed <span class="keyword">then</span></span><br><span class="line">  new_tokens = filled_tokens - requested</span><br><span class="line">  allowed_num = <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- è°ƒç”¨ setex æ¥è®¾ç½® key è¿‡æœŸæ—¶é—´ å’Œ value</span></span><br><span class="line">redis.call(<span class="string">"setex"</span>, tokens_key, ttl, new_tokens)</span><br><span class="line">redis.call(<span class="string">"setex"</span>, timestamp_key, ttl, now)</span><br><span class="line"><span class="comment">-- è¿”å›è¡¨ç¤ºçŠ¶æ€çš„ allowed_num å’Œ å‰©ä½™ tokenæ•°</span></span><br><span class="line"><span class="keyword">return</span> &#123; allowed_num, new_tokens &#125;</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æ˜¯æ•´ä¸ª é™æµè®¡ç®—çš„æµç¨‹å›¾ï¼š<br><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/87bd48d035ec44e6882df34e20b5211a~tplv-k3u1fbpfcp-watermark.image" alt=""></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ratelimiter æ’ä»¶å·§å¦™åœ°è¿ç”¨ Lua è„šæœ¬æ‰§è¡Œ redis æ¥å®ç°ï¼Œä¿è¯äº†æ“ä½œçš„åŸå­æ€§ï¼Œä¹Ÿå€ŸåŠ© redis çš„é«˜é€Ÿç‡ä»¥å‡ ä¹æ— æŸçš„å»¶è¿Ÿåšåˆ°äº†é™æµçš„åŠŸèƒ½ã€‚</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>interview</tag>
      </tags>
  </entry>
  <entry>
    <title>Soul ç½‘å…³æºç åˆ†æï¼ˆåä¸‰ï¼‰divide æ’ä»¶ï¼ˆä¸‰)</title>
    <url>/2021/01/30/Soul-%E7%BD%91%E5%85%B3%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88%E5%8D%81%E4%B8%89%EF%BC%89divide-%E6%8F%92%E4%BB%B6%EF%BC%88%E4%B8%89/</url>
    <content><![CDATA[<p>ä»Šå¤©æˆ‘ä»¬ç»§ç»­çœ‹ divide ä¸‹çš„éšæœºè´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œæ‰‹å…ˆçœ‹ä¸‹ è¿™ä¸ª Random ç±»åœ¨ MomoSec æ’ä»¶ä¸­è¢«è§„åˆ™æ£€æµ‹å‡ºäº†ï¼š<br><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cfaec6cf8d2144b6b70f533412e3d9e6~tplv-k3u1fbpfcp-watermark.image" alt=""></p>
<p>å…¶ä¸­çš„æè¿°æåˆ°ï¼šjava.util.Randomä¾èµ–ä¸€ä¸ªå¯è¢«é¢„æµ‹çš„ä¼ªéšæœºæ•°ç”Ÿæˆå™¨ï¼Œå› ä¸º</p>
<ol>
<li>java.util.Randomç±»ä¸­å®ç°çš„éšæœºç®—æ³•æ˜¯ä¼ªéšæœºï¼Œä¹Ÿå°±æ˜¯æœ‰è§„åˆ™çš„éšæœºï¼Œæ‰€è°“æœ‰è§„åˆ™çš„å°±æ˜¯åœ¨ç»™å®šç§(seed)çš„åŒºé—´å†…éšæœºç”Ÿæˆæ•°å­—ï¼›</li>
<li>ç›¸åŒç§å­æ•°çš„Randomå¯¹è±¡ï¼Œç›¸åŒæ¬¡æ•°ç”Ÿæˆçš„éšæœºæ•°å­—æ˜¯å®Œå…¨ç›¸åŒçš„ï¼›</li>
<li>Randomç±»ä¸­å„æ–¹æ³•ç”Ÿæˆçš„éšæœºæ•°å­—éƒ½æ˜¯å‡åŒ€åˆ†å¸ƒçš„ï¼Œä¹Ÿå°±æ˜¯è¯´åŒºé—´å†…éƒ¨çš„æ•°å­—ç”Ÿæˆçš„å‡ ç‡å‡ç­‰ï¼›</li>
</ol>
<p>å…¶å®è¿™ä¸ªåœ°æ–¹éšæœºæ•°åªæ˜¯ä¸ºäº†è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œä¸ä¼šæœ‰è¿™æ ·çš„é—®é¢˜ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Join</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RandomLoadBalance</span> <span class="keyword">extends</span> <span class="title">AbstractLoadBalance</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//æ— å‚æ„é€ å‡½æ•°åˆ›å»ºçš„ Random å®ä¾‹çš„ seed æ˜¯å½“å¹´çš„ çº³ç§’æ—¶é—´æˆ³</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Random RANDOM = <span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DivideUpstream <span class="title">doSelect</span><span class="params">(<span class="keyword">final</span> List&lt;DivideUpstream&gt; upstreamList, <span class="keyword">final</span> String ip)</span> </span>&#123;</span><br><span class="line">    	<span class="comment">//è®¡ç®—å‡ºæ€»æƒé‡æ•°</span></span><br><span class="line">        <span class="keyword">int</span> totalWeight = calculateTotalWeight(upstreamList);</span><br><span class="line">        <span class="comment">//æ£€æŸ¥æ‰€æœ‰çš„ upstreams åˆ†é…åˆ°çš„æƒé‡æ˜¯å¦å®Œå…¨ç›¸ç­‰</span></span><br><span class="line">        <span class="keyword">boolean</span> sameWeight = isAllUpStreamSameWeight(upstreamList);</span><br><span class="line">        <span class="comment">//å¦‚æœæ€»æƒé‡æ•° &gt; 0 ä¸” upstream åˆ†é…åˆ°çš„æƒé‡éƒ½ä¸ç›¸ç­‰</span></span><br><span class="line">        <span class="keyword">if</span> (totalWeight &gt; <span class="number">0</span> &amp;&amp; !sameWeight) &#123;</span><br><span class="line">        	<span class="comment">// è¿”å›é€‰æ‹©çš„ upstream</span></span><br><span class="line">            <span class="keyword">return</span> random(totalWeight, upstreamList);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// If the weights are the same or the weights are 0 then random</span></span><br><span class="line">        <span class="comment">// å¦‚æœ upstreams åˆ†é…åˆ°çš„æƒé‡å®Œå…¨ç›¸ç­‰ï¼Œæˆ–è€… æ€»æƒé‡æ•° = 0</span></span><br><span class="line">        <span class="keyword">return</span> random(upstreamList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isAllUpStreamSameWeight</span><span class="params">(<span class="keyword">final</span> List&lt;DivideUpstream&gt; upstreamList)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> sameWeight = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">int</span> length = upstreamList.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> weight = getWeight(upstreamList.get(i));</span><br><span class="line">            <span class="keyword">if</span> (i &gt; <span class="number">0</span> &amp;&amp; weight != getWeight(upstreamList.get(i - <span class="number">1</span>))) &#123;</span><br><span class="line">                <span class="comment">// ä¾æ¬¡å’Œå‰ä¸€ä¸ªæ¯”è¾ƒæƒé‡æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœä¸ç­‰å°±è·³å‡ºå½“å‰å¾ªç¯</span></span><br><span class="line">                sameWeight = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sameWeight;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">calculateTotalWeight</span><span class="params">(<span class="keyword">final</span> List&lt;DivideUpstream&gt; upstreamList)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// total weight</span></span><br><span class="line">        <span class="keyword">int</span> totalWeight = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (DivideUpstream divideUpstream : upstreamList) &#123;</span><br><span class="line">            <span class="keyword">int</span> weight = getWeight(divideUpstream);</span><br><span class="line">            <span class="comment">// è®¡ç®—æ€»æƒé‡æ•°</span></span><br><span class="line">            totalWeight += weight;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> totalWeight;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> DivideUpstream <span class="title">random</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> totalWeight, <span class="keyword">final</span> List&lt;DivideUpstream&gt; upstreamList)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// If the weights are not the same and the weights are greater than 0, then random by the total number of weights</span></span><br><span class="line">        <span class="keyword">int</span> offset = RANDOM.nextInt(totalWeight);</span><br><span class="line">        <span class="comment">// Determine which segment the random value falls on</span></span><br><span class="line">        <span class="keyword">for</span> (DivideUpstream divideUpstream : upstreamList) &#123;</span><br><span class="line">            offset -= getWeight(divideUpstream);</span><br><span class="line">            <span class="keyword">if</span> (offset &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> divideUpstream;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> upstreamList.get(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> DivideUpstream <span class="title">random</span><span class="params">(<span class="keyword">final</span> List&lt;DivideUpstream&gt; upstreamList)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> upstreamList.get(RANDOM.nextInt(upstreamList.size()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æ˜¯ ä¸€ä¸ªå·§å¦™çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼šRoundRobinLoadBalanceï¼Œé¦–å…ˆæˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹ç›¸å…³çš„æ¦‚å¿µï¼š</p>
<p>Nginx çš„è´Ÿè½½å‡è¡¡è°ƒåº¦ç®—æ³•é»˜è®¤å°±æ˜¯ round robinï¼Œä¹Ÿå°±æ˜¯è½®è¯¢è°ƒåº¦ç®—æ³•ã€‚æ ¹æ®ç»´åŸºç™¾ç§‘çš„ä»‹ç»ï¼šæœ¯è¯­å¾ªç¯/è½®è½¬/è½®æ›¿ï¼ˆè‹±è¯­ï¼šRound-robinï¼‰ç”¨äºå¤šç§æƒ…å†µä¸­ï¼Œé€šå¸¸æŒ‡å°†å¤šä¸ªæŸç‰©è½®æµç”¨äºæŸäº‹ï¼Œä¾‹å¦‚â€œé€æˆ·æ´¾å¯¹â€ï¼ˆround-robin-partyï¼‰ä¸­æ‰€æœ‰å‚ä¸è€…è¦æŒ¨å®¶æŒ¨æˆ·åœ°æ‹œè®¿æ¯ä½å‚ä¸è€…çš„ä½å¤„å¹¶å‚åŠ é‚£é‡Œçš„å°å‹èšä¼šã€‚è”åä¿¡ï¼ˆround-robin letterï¼‰å¾€å¾€æ˜¯æŒ‡ä¸€å¤§ç¾¤ä¸‹å±ä¸ºæ‰¹è¯„å…¶é¢†å¯¼è€Œå†™çš„ä¸€å°ä¿¡ï¼Œè¿™ç§ä¿¡ä¸€èˆ¬åªåœ¨ç­¾åäººæ•°å¤šåˆ°éš¾äºé€ä¸ªæŠ¥å¤åæ‰ä¼šå¯„å‡ºã€‚</p>
<p>åœ¨è´Ÿè½½å‡è¡¡ç®—æ³•ä¸Šçš„åº”ç”¨ï¼Œä¹Ÿå°±æ˜¯ç”± upstreams è½®æµæ¥å¤„ç†è¯·æ±‚ï¼Œä½†åœ¨ Soul ä¸­ æ˜¯åŠ æƒè½®è¯¢è°ƒåº¦çš„ï¼ŒæŸ¥é˜…<a href="https://www.nginx.com/resources/glossary/round-robin-load-balancing/" target="_blank" rel="noopener">Nginx å®˜æ–¹æ–‡æ¡£å…³äºè½®è¯¢è°ƒåº¦ç®—æ³•çš„æ–‡ç« </a>ï¼Œå‘ç°å¯¹åŠ æƒè½®è¯¢è°ƒåº¦æœ‰ä»¥ä¸‹çš„è§£é‡Šï¼š</p>
<p>Weighted round robin â€“ A weight is assigned to each server based on criteria chosen by the site administrator; the most commonly used criterion is the serverâ€™s trafficâ€‘handling capacity. The higher the weight, the larger the proportion of client requests the server receives. If, for example, server A is assigned a weight of 3 and server B a weight of 1, the load balancer forwards 3 requests to server A for each 1 it sends to server B.</p>
<p>åŠ æƒè½®è¯¢æ˜¯æ ¹æ®ç«™ç‚¹ç®¡ç†å‘˜é€‰æ‹©çš„æ ‡å‡†ä¸ºæ¯ä¸ªæœåŠ¡å™¨åˆ†é…ä¸€ä¸ªæƒé‡çš„ç­–ç•¥ã€‚æœ€å¸¸ç”¨çš„æ ‡å‡†æ˜¯æœåŠ¡å™¨çš„æµé‡å¤„ç†èƒ½åŠ›ã€‚æƒé‡è¶Šé«˜ï¼ŒæœåŠ¡å™¨æ¥æ”¶çš„å®¢æˆ·ç«¯è¯·æ±‚çš„æ¯”ä¾‹è¶Šå¤§ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸ºæœåŠ¡å™¨Aåˆ†é…äº†3çš„æƒé‡ï¼Œä¸ºæœåŠ¡å™¨Båˆ†é…äº†1çš„æƒé‡ï¼Œé‚£ä¹ˆè´Ÿè½½å‡è¡¡å™¨æ¯å‘æœåŠ¡å™¨Bè½¬å‘ 1 ä¸ªè¯·æ±‚ï¼Œå°±ä¼šå‘æœåŠ¡å™¨Aè½¬å‘ 3 ä¸ªè¯·æ±‚ï¼Œå› ä¸ºæœåŠ¡å™¨Aæƒé‡æ›´é«˜ï¼Œä»£è¡¨ä»–å¤„ç†æµé‡çš„èƒ½åŠ›æ›´å¼ºã€‚</p>
<p>åŠ æƒè½®è¯¢ç®—æ³•çš„åŸç†å°±æ˜¯ï¼šæ ¹æ®æœåŠ¡å™¨çš„ä¸åŒå¤„ç†èƒ½åŠ›ï¼Œç»™æ¯ä¸ªæœåŠ¡å™¨åˆ†é…ä¸åŒçš„æƒå€¼ï¼Œä½¿å…¶èƒ½å¤Ÿæ¥å—ç›¸åº”æƒå€¼æ•°çš„æœåŠ¡è¯·æ±‚ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬æ·±å…¥æºç æ¥çœ‹æ˜¯å¦‚ä½•å®ç°çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Join</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoundRobinLoadBalance</span> <span class="keyword">extends</span> <span class="title">AbstractLoadBalance</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//å›æ”¶å‘¨æœŸä¸º 60000 æ¯«ç§’ï¼Œå³ 60 ç§’</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> recyclePeriod = <span class="number">60000</span>;</span><br><span class="line">	<span class="comment">//å‡½æ•°æƒé‡ map</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String, ConcurrentMap&lt;String, WeightedRoundRobin&gt;&gt; methodWeightMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">16</span>);</span><br><span class="line">	<span class="comment">//æ›´æ–°é”ï¼Œç”¨ AtomicBoolean å®ç°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean updateLock = <span class="keyword">new</span> AtomicBoolean();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DivideUpstream <span class="title">doSelect</span><span class="params">(<span class="keyword">final</span> List&lt;DivideUpstream&gt; upstreamList, <span class="keyword">final</span> String ip)</span> </span>&#123;</span><br><span class="line">        String key = upstreamList.get(<span class="number">0</span>).getUpstreamUrl();</span><br><span class="line">        ConcurrentMap&lt;String, WeightedRoundRobin&gt; map = methodWeightMap.get(key);</span><br><span class="line">        <span class="comment">//å°† ç¬¬ä¸€ä¸ª upstream url æ”¾å…¥ å‡½æ•°æƒé‡ map</span></span><br><span class="line">        <span class="keyword">if</span> (map == <span class="keyword">null</span>) &#123;</span><br><span class="line">            methodWeightMap.putIfAbsent(key, <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">16</span>));</span><br><span class="line">            map = methodWeightMap.get(key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> totalWeight = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">long</span> maxCurrent = Long.MIN_VALUE;</span><br><span class="line">        <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">        DivideUpstream selectedInvoker = <span class="keyword">null</span>;</span><br><span class="line">        WeightedRoundRobin selectedWRR = <span class="keyword">null</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (DivideUpstream upstream : upstreamList) &#123;</span><br><span class="line">            String rKey = upstream.getUpstreamUrl();</span><br><span class="line">            WeightedRoundRobin weightedRoundRobin = map.get(rKey);</span><br><span class="line">            <span class="keyword">int</span> weight = getWeight(upstream);</span><br><span class="line">            <span class="comment">//å¦‚æœ weightedRoundRobin ä¸º nullï¼Œåˆ™å®ä¾‹åŒ–ä¸€ä¸ªæ–°çš„ WeightedRoundRobinï¼Œæ”¾å…¥ map ä¸­</span></span><br><span class="line">            <span class="keyword">if</span> (weightedRoundRobin == <span class="keyword">null</span>) &#123;</span><br><span class="line">                weightedRoundRobin = <span class="keyword">new</span> WeightedRoundRobin();</span><br><span class="line">                weightedRoundRobin.setWeight(weight);</span><br><span class="line">                map.putIfAbsent(rKey, weightedRoundRobin);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (weight != weightedRoundRobin.getWeight()) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœæƒé‡ä¸ä¸€è‡´ï¼Œåˆ™æ›´æ–°</span></span><br><span class="line">                weightedRoundRobin.setWeight(weight);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//å°†å½“å‰æƒé‡åŠ åˆ° current ä¸­</span></span><br><span class="line">            <span class="keyword">long</span> cur = weightedRoundRobin.increaseCurrent();</span><br><span class="line">            <span class="comment">//è®¾ç½®æœ€åæ›´æ–°æ—¶é—´</span></span><br><span class="line">            weightedRoundRobin.setLastUpdate(now);</span><br><span class="line">            <span class="comment">//å¦‚æœä¸¤ä¸ªæƒé‡ç›¸ç­‰ï¼Œåˆ™ç¬¬ä¸€ä¸ªè¢«éå†çš„ä¼šè¢«é€‰ä¸­</span></span><br><span class="line">            <span class="keyword">if</span> (cur &gt; maxCurrent) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœå½“å‰å€¼å¤§äºæœ€å¤§å€¼ï¼Œåˆ™æ›´æ–°æœ€å¤§å€¼</span></span><br><span class="line">                maxCurrent = cur;</span><br><span class="line">                <span class="comment">// ç¡®å®šå½“å‰ upstream ä¸ºè¢«é€‰ä¸­çš„è°ƒç”¨è€…</span></span><br><span class="line">                selectedInvoker = upstream;</span><br><span class="line">                <span class="comment">//è¢«é€‰æ‹©çš„åŠ æƒè½®è¯¢è°ƒåº¦</span></span><br><span class="line">                selectedWRR = weightedRoundRobin;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//æ€»æƒé‡æ•°æ±‡æ€»</span></span><br><span class="line">            totalWeight += weight;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœæ›´æ–°é”æœªè¢«æŒæœ‰ä¸” upstreamList å¤§å°ä¸ map ä¸ä¸€è‡´ä¸” åŠ é”æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">if</span> (!updateLock.get() &amp;&amp; upstreamList.size() != map.size() &amp;&amp; updateLock.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// å¤åˆ¶ä¸€ä»½ mapï¼Œç„¶åéå† newMap å¹¶ç§»é™¤ å½“å‰æ—¶é—´å‡å»æœ€åæ›´æ–°æ—¶é—´å¤§äº 60ç§’çš„å…ƒç´ </span></span><br><span class="line">                ConcurrentMap&lt;String, WeightedRoundRobin&gt; newMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(map);</span><br><span class="line">                newMap.entrySet().removeIf(item -&gt; now - item.getValue().getLastUpdate() &gt; recyclePeriod);</span><br><span class="line">                <span class="comment">// å†å°† key æŒ‡å‘æ–°çš„ newMap</span></span><br><span class="line">                methodWeightMap.put(key, newMap);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            	<span class="comment">//æœ€åæ–½æ”¾é”</span></span><br><span class="line">                updateLock.set(<span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (selectedInvoker != <span class="keyword">null</span>) &#123;</span><br><span class="line">        	<span class="comment">//è¢«é€‰ä¸­çš„ weighted round robin çš„ current å‡å»æ€»èŠ‚ç‚¹æƒé‡åˆ†</span></span><br><span class="line">            selectedWRR.sel(totalWeight);</span><br><span class="line">            <span class="keyword">return</span> selectedInvoker;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// should not happen here</span></span><br><span class="line">        <span class="keyword">return</span> upstreamList.get(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…‰çœ‹ä»£ç ï¼Œé€»è¾‘è¿˜æ˜¯æœ‰ç‚¹ä¸æ¸…æ™°ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸‰ä¸ªèŠ‚ç‚¹ABCï¼Œæƒé‡åˆ†åˆ«æ˜¯ 5ï¼Œ3ï¼Œ2ï¼Œåœ¨7æ¬¡è¯·æ±‚çš„æƒ…å†µä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>è¯·æ±‚æ¬¡æ•°</th>
<th>è¯·æ±‚å‰weight</th>
<th>current</th>
<th>é€‰ä¸­èŠ‚ç‚¹</th>
<th>è¯·æ±‚åweight</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>A=5,B=3,C=2</td>
<td>5</td>
<td>A</td>
<td>A=0,B=6,C=4</td>
</tr>
<tr>
<td>2</td>
<td>A=0,B=6,C=4</td>
<td>6</td>
<td>B</td>
<td>A=5,B=2,C=6</td>
</tr>
<tr>
<td>3</td>
<td>A=5,B=2,C=6</td>
<td>6</td>
<td>C</td>
<td>A=10,B=5,C=-1</td>
</tr>
<tr>
<td>4</td>
<td>A=10,B=5,C=-1</td>
<td>10</td>
<td>A</td>
<td>A=6,B=8,C=1</td>
</tr>
<tr>
<td>5</td>
<td>A=6,B=8,C=1</td>
<td>8</td>
<td>B</td>
<td>A=11,B=1,C=3</td>
</tr>
<tr>
<td>6</td>
<td>A=11,B=1,C=3</td>
<td>11</td>
<td>A</td>
<td>A=7,B=4,C=5</td>
</tr>
<tr>
<td>7</td>
<td>A=7,B=4,C=5</td>
<td>7</td>
<td>A</td>
<td>A=-2,B=7,C=7</td>
</tr>
<tr>
<td>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç¬¬ 7 æ¬¡ è¯·æ±‚åçš„ æƒé‡ B å’Œ C éƒ½æ˜¯7ï¼Œå¦‚ä½•åˆ†é…å‘¢ï¼Ÿç­”æ¡ˆå°±åœ¨æºç ä¸­</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (cur &gt; maxCurrent) &#123;</span><br><span class="line">    maxCurrent = cur;</span><br><span class="line">    selectedInvoker = upstream;</span><br><span class="line">    selectedWRR = weightedRoundRobin;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¬¬ä¸€ä¸ªè¢«éå†çš„ upstream ä¼šè¢«é€‰ä¸­ï¼Œæ‰€ä»¥ä¸‹ä¸€æ¬¡è¯·æ±‚å°†ä¼šè½¬å‘åˆ° B èŠ‚ç‚¹ä¸Šã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>RoundRobinLoadBalance åœ¨è®¾è®¡ä¸Šè·Ÿ Nginx æ˜¯ç±»ä¼¼çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºå·¥ä½œæ•ˆç‡è¶Šé«˜çš„ç¨‹åºå‘˜æ¥çš„æ´»è¶Šå¤šï¼Œè´£ä»»ä¹Ÿè¶Šå¤§ï¼Œå› ä¸ºä»–åœ¨é¢†å¯¼å¿ƒä¸­çš„æƒé‡æœ€é«˜ã€‚ğŸ¤£<br>åŠ é”ä½¿ç”¨ AtomicBoolean å®ç°ï¼Œæœ‰æ•ˆé™ä½äº†é”çš„å¼€é”€ã€‚</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>interview</tag>
      </tags>
  </entry>
</search>
